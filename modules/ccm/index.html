



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Workshop and lab content for Amazon Aurora PostgreSQL compatible databases. This code will contain a series of templates, instructional guides and sample code to educate users on how to use Amazon Aurora features.">
      
      
        <link rel="canonical" href="https://mylabs.data-builder.com/modules/ccm/">
      
      
        <meta name="author" content="amazon-aurora-labs-for-mysql@amazon.com">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/aws-favicon.ico">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.4.0">
    
    
      
        <title>Cluster Cache Management - Amazon Aurora Labs for PostgreSQL</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.0284f74d.css">
      
      
    
    
      <script src="../../assets/javascripts/modernizr.74668098.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../../assets/css/custom.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#cluster-cache-management" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <!--
  Copyright (c) 2016-2018 Martin Donath <martin.donath@squidfunk.com>
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Application header -->
<header class="md-header" data-md-component="header">

    <!-- Top-level navigation -->
    <nav class="md-header-nav md-grid">
      <div class="md-flex">

        <!-- Link to home -->
        <div class="md-flex__cell md-flex__cell--shrink">
          <a href="https://aws.amazon.com/"
              title="Amazon Web Services"
              class="md-header-nav__button md-logo">
            
              <img src="../../assets/images/aws_smile_logo.png" width="40" height="24" />
            
          </a>
        </div>

        <!-- Button to toggle drawer -->
        <div class="md-flex__cell md-flex__cell--shrink">
          <label class="md-icon md-icon--menu md-header-nav__button"
              for="__drawer"></label>
        </div>

        <!-- Header title -->
        <div class="md-flex__cell md-flex__cell--stretch">
          <div class="md-flex__ellipsis md-header-nav__title"
              data-md-component="title">
            
              
                <span class="md-header-nav__topic">
                  Amazon Aurora Labs for PostgreSQL
                </span>
                <span class="md-header-nav__topic">
                  Cluster Cache Management
                </span>
              
            
          </div>
        </div>

        <!-- Button to open search dialogue -->
        <div class="md-flex__cell md-flex__cell--shrink">
          
            
              <label class="md-icon md-icon--search md-header-nav__button"
                  for="__search"></label>

              <!-- Search interface -->
              
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
            
          
        </div>

        <!-- Repository containing source -->
        
      </div>
    </nav>
  </header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href="../.." title="Home" class="md-tabs__link">
        Home
      </a>
    
  </li>

      
        
  <li class="md-tabs__item">
    
      <a href="../" title="Getting Started" class="md-tabs__link">
        Getting Started
      </a>
    
  </li>

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../prerequisites/" title="Modules" class="md-tabs__link md-tabs__link--active">
          Modules
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://mylabs.data-builder.com/" title="Amazon Aurora Labs for PostgreSQL" class="md-nav__button md-logo">
      
        <img src="../../assets/images/aws_smile_logo.png" width="48" height="48">
      
    </a>
    Amazon Aurora Labs for PostgreSQL
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../" title="Getting Started" class="md-nav__link">
      Getting Started
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Modules
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Modules
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../prerequisites/" title="Prerequisites" class="md-nav__link">
      Prerequisites
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../create/" title="Creating a New Aurora Cluster" class="md-nav__link">
      Creating a New Aurora Cluster
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../connect/index.md" title="Connecting, Loading Data and Auto Scaling" class="md-nav__link">
      Connecting, Loading Data and Auto Scaling
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../fastclone/" title="Fast Cloning" class="md-nav__link">
      Fast Cloning
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../qpm/" title="Query Plan Management" class="md-nav__link">
      Query Plan Management
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Cluster Cache Management
      </label>
    
    <a href="./" title="Cluster Cache Management" class="md-nav__link md-nav__link--active">
      Cluster Cache Management
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-prerequisite" title="1. Prerequisite" class="md-nav__link">
    1. Prerequisite
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-creating-aurora-postgresql-cluster-with-cloudformation" title="2. Creating Aurora PostgreSQL cluster with Cloudformation" class="md-nav__link">
    2. Creating Aurora PostgreSQL cluster with Cloudformation
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-retrieving-database-credentials-from-secret-manager" title="2.1 Retrieving Database credentials from Secret Manager" class="md-nav__link">
    2.1 Retrieving Database credentials from Secret Manager
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-cloudformation-resource-chart" title="2.2 Cloudformation Resource chart" class="md-nav__link">
    2.2 Cloudformation Resource chart
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-connecting-to-the-ec2-bastion-instance" title="2.3 Connecting to the EC2 bastion Instance" class="md-nav__link">
    2.3 Connecting to the EC2 bastion Instance
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-quick-start-guide-on-using-cluster-cache-management" title="3. Quick Start Guide on using Cluster Cache Management" class="md-nav__link">
    3. Quick Start Guide on using Cluster Cache Management
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-configuring-cluster-cache-management-ccm" title="3.1. Configuring Cluster Cache Management (CCM)" class="md-nav__link">
    3.1. Configuring Cluster Cache Management (CCM)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-verifying-if-ccm-is-enabled" title="3.2. Verifying if CCM is enabled" class="md-nav__link">
    3.2. Verifying if CCM is enabled
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-benchmarking-with-ccm-enabled-before-failover" title="4. Benchmarking with CCM enabled (before Failover)" class="md-nav__link">
    4. Benchmarking with CCM enabled (before Failover)
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-using-pg_buffercache-ccm-enabled" title="4.1 Using pg_buffercache (CCM enabled)" class="md-nav__link">
    4.1 Using pg_buffercache (CCM enabled)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-collecting-the-pgbench-benchmarking-metrics" title="4.2 Collecting the pgbench benchmarking metrics." class="md-nav__link">
    4.2 Collecting the pgbench benchmarking metrics.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43-ccm-enabled-failover-benchmarking" title="4.3 CCM enabled failover benchmarking" class="md-nav__link">
    4.3 CCM enabled failover benchmarking
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#44-benchmarking-on-ccm-disabled-cluster" title="4.4 Benchmarking on CCM disabled cluster" class="md-nav__link">
    4.4 Benchmarking on CCM disabled cluster
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#45-using-pg_buffercache-ccm-disabled" title="4.5. Using pg_buffercache (CCM disabled)" class="md-nav__link">
    4.5. Using pg_buffercache (CCM disabled)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#46-ccm-vs-no-ccm-benchmarking-results-for-illustration-only" title="4.6. CCM vs no CCM benchmarking results (for illustration only)" class="md-nav__link">
    4.6. CCM vs no CCM benchmarking results (for illustration only)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../migration/" title="Oracle to Aurora PostgreSQL migration using DMS and SCT" class="md-nav__link">
      Oracle to Aurora PostgreSQL migration using DMS and SCT
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../das/" title="Database Activity Streaming" class="md-nav__link">
      Database Activity Streaming
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-prerequisite" title="1. Prerequisite" class="md-nav__link">
    1. Prerequisite
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-creating-aurora-postgresql-cluster-with-cloudformation" title="2. Creating Aurora PostgreSQL cluster with Cloudformation" class="md-nav__link">
    2. Creating Aurora PostgreSQL cluster with Cloudformation
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-retrieving-database-credentials-from-secret-manager" title="2.1 Retrieving Database credentials from Secret Manager" class="md-nav__link">
    2.1 Retrieving Database credentials from Secret Manager
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-cloudformation-resource-chart" title="2.2 Cloudformation Resource chart" class="md-nav__link">
    2.2 Cloudformation Resource chart
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-connecting-to-the-ec2-bastion-instance" title="2.3 Connecting to the EC2 bastion Instance" class="md-nav__link">
    2.3 Connecting to the EC2 bastion Instance
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-quick-start-guide-on-using-cluster-cache-management" title="3. Quick Start Guide on using Cluster Cache Management" class="md-nav__link">
    3. Quick Start Guide on using Cluster Cache Management
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#31-configuring-cluster-cache-management-ccm" title="3.1. Configuring Cluster Cache Management (CCM)" class="md-nav__link">
    3.1. Configuring Cluster Cache Management (CCM)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#32-verifying-if-ccm-is-enabled" title="3.2. Verifying if CCM is enabled" class="md-nav__link">
    3.2. Verifying if CCM is enabled
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-benchmarking-with-ccm-enabled-before-failover" title="4. Benchmarking with CCM enabled (before Failover)" class="md-nav__link">
    4. Benchmarking with CCM enabled (before Failover)
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#41-using-pg_buffercache-ccm-enabled" title="4.1 Using pg_buffercache (CCM enabled)" class="md-nav__link">
    4.1 Using pg_buffercache (CCM enabled)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#42-collecting-the-pgbench-benchmarking-metrics" title="4.2 Collecting the pgbench benchmarking metrics." class="md-nav__link">
    4.2 Collecting the pgbench benchmarking metrics.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#43-ccm-enabled-failover-benchmarking" title="4.3 CCM enabled failover benchmarking" class="md-nav__link">
    4.3 CCM enabled failover benchmarking
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#44-benchmarking-on-ccm-disabled-cluster" title="4.4 Benchmarking on CCM disabled cluster" class="md-nav__link">
    4.4 Benchmarking on CCM disabled cluster
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#45-using-pg_buffercache-ccm-disabled" title="4.5. Using pg_buffercache (CCM disabled)" class="md-nav__link">
    4.5. Using pg_buffercache (CCM disabled)
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#46-ccm-vs-no-ccm-benchmarking-results-for-illustration-only" title="4.6. CCM vs no CCM benchmarking results (for illustration only)" class="md-nav__link">
    4.6. CCM vs no CCM benchmarking results (for illustration only)
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="cluster-cache-management">Cluster Cache Management<a class="headerlink" href="#cluster-cache-management" title="Permanent link">&para;</a></h1>
<h2 id="1-prerequisite">1. Prerequisite<a class="headerlink" href="#1-prerequisite" title="Permanent link">&para;</a></h2>
<p><strong>Create an EC2 Key Pair</strong>: <br> </p>
<p>You will need an EC2 key pair in order to log into the EC2 bastion instance<br></p>
<p>To create a new key pair: </p>
<ol>
<li>Open the EC2 service console</li>
<li>In the left-hand gutter under “Network &amp; Security” click “Key Pairs”</li>
<li>Supply a name and click “Create”</li>
<li>Download or otherwise save the .pem file</li>
</ol>
<h2 id="2-creating-aurora-postgresql-cluster-with-cloudformation">2. Creating Aurora PostgreSQL cluster with Cloudformation<a class="headerlink" href="#2-creating-aurora-postgresql-cluster-with-cloudformation" title="Permanent link">&para;</a></h2>
<ol>
<li><a href="https://us-west-2.console.aws.amazon.com/cloudformation/home?region=us-west-2" target="_blank">Log in to your AWS console and go to the CloudFormation landing page</a></li>
<li>Click create stack, select ‘Specify an Amazon S3 template URL’ and launch the CloudFormation stack from this <a href="https://tinyurl.com/my-cf-template" target="_blank">template</a></li>
<li>Download and save this locally and use upload a template to S3 option and click on “Choose File” option to point to the location where you have saved the template.</li>
<li>Here is a screenshot of the first page – 
<span class="image"><img alt="1-qpm-cf1" src="1-qpm-cf1.png?raw=true" /></span>
<br>
<span class="image"><img alt="1-qpm-cf-2" src="1-qpm-cf-2.png?raw=true" /></span><br>
<span class="image"><img alt="1-qpm-cf-3" src="1-qpm-cf-3.png?raw=true" /></span><br>
<span class="image"><img alt="1-qpm-cf-4" src="1-qpm-cf-4.png?raw=true" /></span><br>
<span class="image"><img alt="1-qpm-cf-5" src="1-qpm-cf-5.png?raw=true" /></span><br>
<span class="image"><img alt="1-qpm-cf-6" src="1-qpm-cf-6.png?raw=true" /></span><br>
<span class="image"><img alt="1-qpm-cf-7" src="1-qpm-cf-7.png?raw=true" /></span><br>
<span class="image"><img alt="1-qpm-cf-8" src="1-qpm-cf-8.png?raw=true" /></span><br>
<span class="image"><img alt="1-qpm-cf-9" src="1-qpm-cf-9.png?raw=true" /></span><br>
<span class="image"><img alt="1-qpm-cf-10" src="1-qpm-cf-10.png?raw=true" /></span><br>
<span class="image"><img alt="1-qpm-cf-11" src="1-qpm-cf-11.png?raw=true" /></span><br></li>
</ol>
<h3 id="21-retrieving-database-credentials-from-secret-manager">2.1 Retrieving Database credentials from Secret Manager<a class="headerlink" href="#21-retrieving-database-credentials-from-secret-manager" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p>Search for the secret name as shown in the output of the stack and select the secret name.
<span class="image"><img alt="1-qpm-secrets-1" src="1-qpm-secrets-1.png?raw=true" /></span><br> </p>
</li>
<li>
<p>Click on the Retrieve secret value to get the Database user and the password to connect to the Aurora Database.
<span class="image"><img alt="1-qpm-secrets-2" src="1-qpm-secrets-2.png?raw=true" /></span><br>
<span class="image"><img alt="1-qpm-secrets-3" src="1-qpm-secrets-3.png?raw=true" /></span><br>
<span class="image"><img alt="1-qpm-secrets-4" src="1-qpm-secrets-4.png?raw=true" /></span><br></p>
</li>
</ol>
<h3 id="22-cloudformation-resource-chart">2.2 Cloudformation Resource chart<a class="headerlink" href="#22-cloudformation-resource-chart" title="Permanent link">&para;</a></h3>
<p>Please note that the Database names and the Custom Cluster and Database Parameter groups shown below are only for illustrative purpose. Participants are required to use the appropriate resources created from the Cloudformation template.</p>
<p><strong>Please refer the below table for the list of resources and the value</strong></p>
<table>
<thead>
<tr>
<th>Resource name</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Cluster Parameter Group</td>
<td>refer CloudFormation template output section and refer the key value “apgcustomclusterparamgroup”</td>
</tr>
<tr>
<td>Database Parameter Group</td>
<td>refer CloudFormation template output section and refer the key value “apgcustomdbparamgroup”</td>
</tr>
<tr>
<td>Cluster Endpoint</td>
<td>refer CloudFormation template output section and refer the key value “clusterEndpoint”</td>
</tr>
<tr>
<td>Reader Endpoint</td>
<td>refer CloudFormation template output section and refer the key value “readerEndpoint”</td>
</tr>
<tr>
<td>DB name</td>
<td>mylab</td>
</tr>
<tr>
<td>DB username</td>
<td>masteruser</td>
</tr>
<tr>
<td>DB password</td>
<td>extract from the secrets Manager as shown above</td>
</tr>
<tr>
<td>bastionEndpoint</td>
<td>refer CloudFormation template output section and refer the key value “bastionEndpoint”</td>
</tr>
</tbody>
</table>
<h3 id="23-connecting-to-the-ec2-bastion-instance">2.3 Connecting to the EC2 bastion Instance<a class="headerlink" href="#23-connecting-to-the-ec2-bastion-instance" title="Permanent link">&para;</a></h3>
<p>We are creating EC2 instance (Amazon Linux AMI-ID ami-0f2176987ee50226e) and bootstrapping the EC2 Instance to have pgbench and sysbench benchmarking tools to be installed.</p>
<div class="codehilite"><pre><span></span><span class="n">ssh</span> <span class="o">-</span><span class="n">i</span> <span class="o">&lt;</span><span class="n">keypair</span><span class="p">.</span><span class="n">pem</span><span class="o">&gt;</span> <span class="n">ec2</span><span class="o">-</span><span class="k">user</span><span class="o">@&lt;</span><span class="n">bastionEndpoint</span><span class="o">&gt;</span>
</pre></div>


<p>Replace the [<code>keypair.pem</code>] with the keypair file name input provided to the Cloud formation template. Replace the “bastionEndpoint” with the key value from the output section of the Cloud formation template.</p>
<p>If you need to open an access for your laptop IP specifically, then whitelist your IP, by specifying your IP in the format <code>x.x.x.x/32</code> (<a href=" http://www.whatsmyip.org/" target="_blank">Lookup your IP </a>). If there are any issues in accessing the instance, you can always modify the security group to populate your IP address as My IP as mentioned <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/authorizing-access-to-an-instance.html" target="_blank"> here</a>. </p>
<h2 id="3-quick-start-guide-on-using-cluster-cache-management">3. Quick Start Guide on using Cluster Cache Management<a class="headerlink" href="#3-quick-start-guide-on-using-cluster-cache-management" title="Permanent link">&para;</a></h2>
<p>Cluster cache management is supported for Aurora PostgreSQL DB clusters of versions 9.6.11 and above, and versions 10.5 and above.</p>
<h3 id="31-configuring-cluster-cache-management-ccm">3.1. Configuring Cluster Cache Management (CCM)<a class="headerlink" href="#31-configuring-cluster-cache-management-ccm" title="Permanent link">&para;</a></h3>
<p>Following are the steps to configure and enable the use of CCM on your Aurora PostgreSQL cluster</p>
<ol>
<li>Modify the Amazon Aurora DB Cluster Parameters related to the CCM. Screenshots of some of the steps are shown below</li>
</ol>
<p>a. <a href="https://console.aws.amazon.com/rds/" target="_blank"> Sign in to the AWS Management Console and open the Amazon RDS console</a> <br>
  b. In the navigation pane, choose Parameter groups.
<span class="image"><img alt="1-ccm-guide-1" src="1-ccm-guide-1.png?raw=true" /></span><br>
c. In the list, choose the parameter group for your Aurora PostgreSQL DB cluster.  Please refer the name of the DB cluster parameter group file 
<span class="image"><img alt="1-ccm-guide-2" src="1-ccm-guide-2.png?raw=true" /></span><br>
created from the output section of the CloudFormation Stack. It is in the format <stack-name-apgcustom-clusterparamgroup-nnnn>. In this case the stack name is “labstack” and hence the DB cluster parameter group file is “labstack- apgcustom-clusterparamgroup-nnnn &gt;. The DB cluster must use a parameter group other than the default, because you can't change values in a default parameter group.
For more information , <a href="https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/USER_WorkingWithParamGroups.html#USER_WorkingWithParamGroups.CreatingCluster" target="_blank"> see Creating a DB Cluster Parameter Group</a>.<br>
d. Click on the DB cluster parameter group selected above and then click on “Edit Parameters” 
<span class="image"><img alt="1-ccm-guide-3" src="1-ccm-guide-3.png?raw=true" /></span><br>
e. Set the value of the apg_ccm_enabled cluster parameter to 1 and click on “Save changes”
<span class="image"><img alt="1-ccm-guide-4" src="1-ccm-guide-4.png?raw=true" /></span><br>
f. Choose Save changes. For more Information,<a href="https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/USER_WorkingWithParamGroups.html#USER_WorkingWithParamGroups.ModifyingCluster" target="_blank">see Modifying Parameters in a DB Cluster Parameter Group</a>. <br>
<br>
2. Set the Promotion Tier Priority for the Writer DB Instance
<br>
<br>
a. <a href="https://console.aws.amazon.com/rds/" target="_blank"> Sign in to the AWS Management Console and open the Amazon RDS console</a> . <br> <br>
b. In the navigation pane, choose Databases. <br><br>
c. Choose the Writer DB instance of the Aurora PostgreSQL DB cluster and click on “Modify”<br><br>
<span class="image"><img alt="1-ccm-guide-5" src="1-ccm-guide-5.png?raw=true" /></span><br><br>
d. Choose Modify. The Modify DB Instance page appears.
<span class="image"><img alt="1-ccm-guide-6" src="1-ccm-guide-6.png?raw=true" /></span><br>
e. On the Failover panel, choose tier-0 for the Priority.
<span class="image"><img alt="1-ccm-guide-7" src="1-ccm-guide-7.png?raw=true" /></span><br>
f. Choose Continue and check the summary of modifications.
g. To apply the changes immediately after you save them, choose Apply immediately.
<span class="image"><img alt="1-ccm-guide-8" src="1-ccm-guide-8.png?raw=true" /></span><br>
h. Choose Modify DB Instance to save your changes
For more information about setting the promotion tier, <a href="https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/Aurora.Modifying.html#Aurora.Modifying.Instance" target="_blank"> see Modify a DB Instance in a DB Cluster and the Promotion tier setting</a>. See also, <a href="https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/Aurora.Managing.Backups.html#Aurora.Managing.FaultTolerance" target="_blank">Fault Tolerance for an Aurora DB Cluster </a>.
<br>
3. Set the Promotion Tier Priority for the Reader DB Instance 
Repeat the steps from the above section 2 for the reader instance to act as a failover target. To designate a specific replica for cluster cache management, set the promotion tier priority to 0 for that Aurora replica. The promotion tier priority is a value that specifies the order in which an Aurora replica is promoted to the primary DB instance after a failure. Valid values are 0 to 15, where 0 is the highest and 15 the lowest priority. </p>
<p>a. <a href="https://console.aws.amazon.com/rds/" target="_blank"> Sign in to the AWS Management Console and open the Amazon RDS console</a> . <br> 
b. In the navigation pane, choose Databases. <br>
c. Choose the Reader DB instance of the Aurora PostgreSQL DB cluster and click on “Modify”
<span class="image"><img alt="1-ccm-guide-9" src="1-ccm-guide-9.png?raw=true" /></span><br>
d. Choose Modify. The Modify DB Instance page appears.
<span class="image"><img alt="1-ccm-guide-10" src="1-ccm-guide-10.png?raw=true" /></span><br>
e. On the Failover panel, choose tier-0 for the Priority.<br> 
<span class="image"><img alt="1-ccm-guide-11" src="1-ccm-guide-11.png?raw=true" /></span><br>
f. Choose Continue and check the summary of modifications.<br> <br>
g. To apply the changes immediately after you save them, choose Apply immediately.
<span class="image"><img alt="1-ccm-guide-12" src="1-ccm-guide-12.png?raw=true" /></span><br>
h. Choose Modify DB Instance to save your changes</p>
<h3 id="32-verifying-if-ccm-is-enabled">3.2. Verifying if CCM is enabled<a class="headerlink" href="#32-verifying-if-ccm-is-enabled" title="Permanent link">&para;</a></h3>
<p>To verify if the CCM is enabled, query the function aurora_ccm_status() with the following code using psql. </p>
<p>Please refer the documentation on how to connect to PostgreSQL using psql here.
(please replace the endpoint, port, username and the database name with your specific setup).</p>
<p>a. <a href="https://console.aws.amazon.com/rds/" target="_blank"> Sign in to the AWS Management Console and open the Amazon RDS console</a> . 
b.  In the navigation pane, choose Databases and click on the DB identifier with the cluster name you created as a part of the CloudFormation stack.
<span class="image"><img alt="1-ccm-guide-13" src="1-ccm-guide-13.png?raw=true" /></span><br>
c. Click on the selected cluster above and look under the section “Connectivity and Security”. You will see 2 different endpoints under the “Type” column. The one on the top will be the cluster endpoint (for read-write) and the other one will be reader endpoint (for read-only).<br>
<span class="image"><img alt="1-ccm-guide-14" src="1-ccm-guide-14.png?raw=true" /></span><br>
d. Choose the Writer DB instance of the Aurora PostgreSQL DB</p>
<div class="codehilite"><pre><span></span><span class="p">.</span><span class="o">/</span><span class="n">psql</span> <span class="o">-</span><span class="n">h</span> <span class="o">&lt;</span><span class="k">cluster</span><span class="o">-</span><span class="n">endpoint</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">p</span> <span class="o">&lt;</span><span class="n">port</span><span class="o">&gt;-</span> <span class="n">U</span> <span class="o">&lt;</span><span class="n">username</span><span class="o">&gt;</span> <span class="o">-</span><span class="n">d</span> <span class="o">&lt;</span><span class="n">dbname</span><span class="o">&gt;</span>
<span class="n">cd</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">ec2</span><span class="o">-</span><span class="k">user</span><span class="o">/</span><span class="n">postgresql</span><span class="o">-</span><span class="mi">10</span><span class="p">.</span><span class="mi">7</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">psql</span>
<span class="n">export</span> <span class="n">PATH</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">ec2</span><span class="o">-</span><span class="k">user</span><span class="o">/</span><span class="n">postgresql</span><span class="o">-</span><span class="mi">10</span><span class="p">.</span><span class="mi">7</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="p">:</span><span class="err">$</span><span class="n">PATH</span>
<span class="p">.</span><span class="o">/</span><span class="n">psql</span> <span class="o">-</span><span class="n">h</span>  <span class="n">labstack</span><span class="o">-</span><span class="k">cluster</span><span class="p">.</span><span class="k">cluster</span><span class="o">-</span><span class="n">xxxxxxxxx</span><span class="p">.</span><span class="n">us</span><span class="o">-</span><span class="n">west</span><span class="o">-</span><span class="mi">2</span><span class="p">.</span><span class="n">rds</span><span class="p">.</span><span class="n">amazonaws</span><span class="p">.</span><span class="n">com</span> <span class="o">-</span><span class="n">p</span> <span class="mi">5432</span> <span class="o">-</span><span class="n">U</span>  <span class="n">masteruser</span> <span class="o">-</span><span class="n">d</span> <span class="n">mylab</span>
</pre></div>


<div class="codehilite"><pre><span></span><span class="n">mylab</span><span class="o">=&gt;</span> <span class="k">select</span> <span class="n">aurora_version</span><span class="p">(),</span><span class="k">version</span><span class="p">();</span>
 <span class="n">aurora_version</span> <span class="o">|</span>                                   <span class="k">version</span>                                   
<span class="c1">----------------+-----------------------------------------------------------------------------</span>
 <span class="mi">2</span><span class="p">.</span><span class="mi">3</span><span class="p">.</span><span class="mi">5</span>          <span class="o">|</span> <span class="n">PostgreSQL</span> <span class="mi">10</span><span class="p">.</span><span class="mi">7</span> <span class="k">on</span> <span class="n">x86_64</span><span class="o">-</span><span class="n">pc</span><span class="o">-</span><span class="n">linux</span><span class="o">-</span><span class="n">gnu</span><span class="p">,</span> <span class="n">compiled</span> <span class="k">by</span> <span class="n">gcc</span> <span class="p">(</span><span class="n">GCC</span><span class="p">)</span> <span class="mi">4</span><span class="p">.</span><span class="mi">9</span><span class="p">.</span><span class="mi">3</span><span class="p">,</span> <span class="mi">64</span><span class="o">-</span><span class="nb">bit</span>
<span class="p">(</span><span class="mi">1</span> <span class="k">row</span><span class="p">)</span>
<span class="n">mylab</span><span class="o">=&gt;</span> <span class="err">\</span><span class="n">x</span>
<span class="n">Expanded</span> <span class="n">display</span> <span class="k">is</span> <span class="k">on</span><span class="p">.</span>
<span class="n">ccmdb</span><span class="o">=&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">aurora_ccm_status</span><span class="p">();</span>
<span class="o">-</span> <span class="p">[</span> <span class="n">RECORD</span> <span class="mi">1</span> <span class="p">]</span><span class="c1">--------------+---------</span>
<span class="n">buffers_sent_last_minute</span>    <span class="o">|</span> <span class="mi">2242000</span>
<span class="n">buffers_found_last_minute</span>   <span class="o">|</span> <span class="mi">2242003</span>
<span class="n">buffers_sent_last_scan</span>      <span class="o">|</span> <span class="mi">17920442</span>
<span class="n">buffers_found_last_scan</span>     <span class="o">|</span> <span class="mi">17923410</span>
<span class="n">buffers_sent_current_scan</span>   <span class="o">|</span> <span class="mi">14098000</span>
<span class="n">buffers_found_current_scan</span>  <span class="o">|</span> <span class="mi">14100964</span>
<span class="n">current_scan_progress</span>       <span class="o">|</span> <span class="mi">15877443</span>
</pre></div>


<p>If the Cluster Cache management is not enabled. Querying aurora_ccm_status() will display the below output</p>
<div class="codehilite"><pre><span></span><span class="n">mylab</span><span class="o">=&gt;</span> <span class="err">\</span><span class="n">x</span>
<span class="n">Expanded</span> <span class="n">display</span> <span class="k">is</span> <span class="k">on</span><span class="p">.</span>
<span class="n">noccmdb</span><span class="o">=&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">aurora_ccm_status</span><span class="p">();</span>
<span class="n">ERROR</span><span class="p">:</span>  <span class="k">Cluster</span> <span class="k">Cache</span> <span class="n">Manager</span> <span class="k">is</span> <span class="n">disabled</span>
<span class="n">noccmdb</span><span class="o">=&gt;</span>
</pre></div>


<h2 id="4-benchmarking-with-ccm-enabled-before-failover">4. Benchmarking with CCM enabled (before Failover)<a class="headerlink" href="#4-benchmarking-with-ccm-enabled-before-failover" title="Permanent link">&para;</a></h2>
<p>Please refer above table for the resource’s appropriate values for cluster endpoint, DB name etc...</p>
<p>Please note that the scale factor 10000 is used for the data load in the sample CCMDB. For the Database created with the Cloudformation template we are using scale factor=100.</p>
<div class="codehilite"><pre><span></span><span class="n">Optional</span><span class="p">:</span> <span class="o">-</span> <span class="k">In</span> <span class="k">order</span> <span class="k">to</span> <span class="n">reproduce</span> <span class="n">the</span> <span class="n">benchmarking</span> <span class="n">used</span> <span class="k">in</span> <span class="n">the</span> <span class="n">lab</span><span class="p">,</span> <span class="n">we</span> <span class="n">need</span> <span class="k">to</span> <span class="k">add</span> <span class="k">more</span> <span class="n">sample</span> <span class="k">data</span> <span class="k">to</span> <span class="n">our</span> <span class="n">benchmark</span><span class="p">.</span> <span class="n">The</span> <span class="n">below</span> <span class="n">command</span> <span class="k">is</span> <span class="k">using</span> <span class="k">scale</span> <span class="n">factor</span> <span class="k">of</span> <span class="mi">10000</span><span class="p">.</span>

<span class="p">.</span><span class="o">/</span><span class="n">pgbench</span> <span class="o">-</span><span class="n">i</span> <span class="c1">--fillfactor=100 --scale=10000 --host=labstack-cluster.cluster-xxxxxxxxx.us-west-2.rds.amazonaws.com—username= masteruser mylab</span>
</pre></div>


<p>Connect to the Writer node using cluster endpoint of the cluster we created.</p>
<p>a. <a href="https://console.aws.amazon.com/rds/" target="_blank"> Sign in to the AWS Management Console and open the Amazon RDS console</a> .</p>
<p>b. In the navigation pane, choose Databases and click on the DB identifier with the cluster name you created as a part of the CloudFormation stack.
<span class="image"><img alt="1-ccm-guide-15" src="1-ccm-guide-15.png?raw=true" /></span><br></p>
<p>c. Click on the selected cluster above and look under the section “Connectivity and Security”. You will see 2 different endpoints under the “Type” column. The one on the top will be the cluster endpoint (for read-write) and the other one will be reader endpoint (for read-only).
<span class="image"><img alt="1-ccm-guide-16" src="1-ccm-guide-16.png?raw=true" /></span><br>
d. Choose the Writer Endpoint of the Aurora PostgreSQL Cluster.</p>
<div class="codehilite"><pre><span></span><span class="p">.</span><span class="o">/</span><span class="n">psql</span> <span class="o">-</span><span class="n">h</span>  <span class="n">labstack</span><span class="o">-</span><span class="k">cluster</span><span class="p">.</span><span class="k">cluster</span><span class="o">-</span><span class="n">xxxxxxxxx</span><span class="p">.</span><span class="n">us</span><span class="o">-</span><span class="n">west</span><span class="o">-</span><span class="mi">2</span><span class="p">.</span><span class="n">rds</span><span class="p">.</span><span class="n">amazonaws</span><span class="p">.</span><span class="n">com</span> <span class="o">-</span><span class="n">p</span> <span class="mi">5432</span> <span class="o">-</span><span class="n">U</span>  <span class="n">masteruser</span> <span class="o">-</span><span class="n">d</span> <span class="n">mylab</span>
</pre></div>


<p>e. Choose the Writer Endpoint of the Aurora PostgreSQL Cluster.</p>
<div class="codehilite"><pre><span></span><span class="n">mylab</span><span class="o">=&gt;</span> <span class="k">SELECT</span> <span class="n">pg_size_pretty</span><span class="p">(</span> <span class="n">pg_database_size</span><span class="p">(</span><span class="s1">&#39;mylab&#39;</span><span class="p">));</span>
 <span class="n">pg_size_pretty</span> 
<span class="c1">----------------</span>
 <span class="mi">1643</span> <span class="n">MB</span>
<span class="p">(</span><span class="mi">1</span> <span class="k">row</span><span class="p">)</span>
</pre></div>


<p>If optionally you have used the scale factor 10000</p>
<div class="codehilite"><pre><span></span><span class="n">mylab</span><span class="o">=&gt;</span> <span class="k">SELECT</span> <span class="n">pg_size_pretty</span><span class="p">(</span> <span class="n">pg_database_size</span><span class="p">(</span><span class="s1">&#39;mylab&#39;</span><span class="p">)</span> <span class="p">);</span>
 <span class="n">pg_size_pretty</span> 
<span class="c1">----------------</span>
 <span class="mi">171</span> <span class="n">GB</span>
<span class="p">(</span><span class="mi">1</span> <span class="k">row</span><span class="p">)</span> 
</pre></div>


<p><strong>Running the benchmarking</strong></p>
<p>We are using <a href="https://www.postgresql.org/docs/10/pgbench.html" target="_blank">pgbench </a>  benchmarking option tpcb-like and using “@” to specify the probability of running read-only workload and read-write workload. In the below example we are running tpcb-like workload with 20X read-only workload and 1x read-write workload for 600 seconds.</p>
<div class="codehilite"><pre><span></span><span class="p">.</span><span class="o">/</span><span class="n">pgbench</span>  <span class="o">--</span><span class="n">progress</span><span class="o">-</span><span class="n">timestamp</span> <span class="o">-</span><span class="n">M</span> <span class="n">prepared</span> <span class="o">-</span><span class="n">n</span> <span class="o">-</span><span class="n">T</span> <span class="mi">600</span> <span class="o">-</span><span class="n">P</span> <span class="mi">5</span>  <span class="o">-</span><span class="n">c</span> <span class="mi">50</span> <span class="o">-</span><span class="n">j</span> <span class="mi">50</span>  <span class="o">--</span><span class="n">host</span><span class="o">=</span><span class="n">labstack</span><span class="o">-</span><span class="n">cluster</span><span class="p">.</span><span class="n">cluster</span><span class="o">-</span><span class="n">xxxxxxxxx</span><span class="p">.</span><span class="n">us</span><span class="o">-</span><span class="n">west</span><span class="o">-</span><span class="mf">2.</span><span class="n">rds</span><span class="p">.</span><span class="n">amazonaws</span><span class="p">.</span><span class="n">com</span> <span class="o">-</span><span class="n">b</span> <span class="n">tpcb</span><span class="o">-</span><span class="n">like</span><span class="mi">@1</span> <span class="o">-</span><span class="n">b</span> <span class="n">select</span><span class="o">-</span><span class="n">only</span><span class="mi">@20</span> <span class="o">--</span><span class="n">username</span><span class="o">=</span><span class="n">masteruser</span> <span class="n">mylab</span><span class="o">&gt;</span> <span class="n">ccm_enable_before_failover</span><span class="p">.</span><span class="k">out</span> 
</pre></div>


<h3 id="41-using-pg_buffercache-ccm-enabled">4.1 Using pg_buffercache (CCM enabled)<a class="headerlink" href="#41-using-pg_buffercache-ccm-enabled" title="Permanent link">&para;</a></h3>
<p>Pg_buffercache extension provides a means to look into the contents of the buffer cache. We will be leveraging the pg_buffercache view to examine the content of the buffer cache (with the CCM enabled and CCM disabled) to illustrate the effect of the CCM. We will compare the content of the buffer cache of the Writer node with the Read-only node. </p>
<p>With CCM enabled the content of the buffer cache of the writer node and the read-only will be similar due to the fact that in the CCM enabled cluster the Writer node will periodically sends buffer addresses of the frequently used buffers (defaults to usage count&gt;3) to the Read-only node. The content of the pg_buffercache view is generated with different dataset (Scale =10000) as compared to (scale=100) used in this workshop so you will be getting different results.</p>
<p>Connect to the Writer node using the cluster endpoint of your cluster.</p>
<p>a. <a href="https://console.aws.amazon.com/rds/" target="_blank"> Sign in to the AWS Management Console and open the Amazon RDS console</a> .<br>
b.  In the navigation pane, choose Databases and click on the DB identifier with the cluster name you created as a part of the CloudFormation stack. <br>
<span class="image"><img alt="1-ccm-guide-17" src="1-ccm-guide-17.png?raw=true" /></span><br>
c.  Click on the selected cluster above and look under the section “Connectivity and Security”. You will see 2 different endpoints under the “Type” column. The one on the top will be the cluster endpoint (for read-write) and the other one will be reader endpoint (for read-only).
<span class="image"><img alt="1-ccm-guide-18" src="1-ccm-guide-18.png?raw=true" /></span><br>
d.  Choose the Writer Endpoint of the Aurora PostgreSQL Cluster.</p>
<div class="codehilite"><pre><span></span><span class="p">.</span><span class="o">/</span><span class="n">psql</span> <span class="o">-</span><span class="n">h</span>  <span class="n">labstack</span><span class="o">-</span><span class="k">cluster</span><span class="p">.</span><span class="k">cluster</span><span class="o">-</span><span class="n">xxxxxxxxx</span><span class="p">.</span><span class="n">us</span><span class="o">-</span><span class="n">west</span><span class="o">-</span><span class="mi">2</span><span class="p">.</span><span class="n">rds</span><span class="p">.</span><span class="n">amazonaws</span><span class="p">.</span><span class="n">com</span> <span class="o">-</span><span class="n">p</span> <span class="mi">5432</span> <span class="o">-</span><span class="n">U</span>  <span class="n">masteruser</span> <span class="o">-</span><span class="n">d</span> <span class="n">mylab</span>
</pre></div>


<p>e.  Create extension pg_buffercache on the Database.</p>
<div class="codehilite"><pre><span></span><span class="nv">mylab</span><span class="o">=&gt;</span> <span class="nv">CREATE</span> <span class="nv">EXTENSION</span> <span class="nv">pg_buffercache</span><span class="c1">;</span>
<span class="nv">CREATE</span> <span class="nv">EXTENSION</span>
<span class="nv">ccmdb</span><span class="o">=&gt;</span> \<span class="nv">dx</span> <span class="nv">pg_buffercache</span>
                    <span class="nv">List</span> <span class="nv">of</span> <span class="nv">installed</span> <span class="nv">extensions</span>
      <span class="nv">Name</span>      <span class="o">|</span> <span class="nv">Version</span> <span class="o">|</span> <span class="nv">Schema</span> <span class="o">|</span>           <span class="nv">Description</span>           
<span class="o">----------------+---------+--------+---------------------------------</span>
 <span class="nv">pg_buffercache</span> <span class="o">|</span> <span class="mi">1</span>.<span class="mi">3</span>     <span class="o">|</span> <span class="nv">public</span> <span class="o">|</span> <span class="nv">examine</span> <span class="nv">the</span> <span class="nv">shared</span> <span class="nv">buffer</span> <span class="nv">cache</span>
<span class="ss">(</span><span class="mi">1</span> <span class="nv">row</span><span class="ss">)</span>

<span class="o">--</span> <span class="nv">Verify</span> <span class="k">if</span> <span class="nv">we</span> <span class="nv">are</span> <span class="nv">connected</span> <span class="nv">to</span> <span class="nv">the</span> <span class="nv">Writer</span> <span class="nv">node</span>.

<span class="nv">ccmdb</span><span class="o">=&gt;</span> <span class="k">show</span> <span class="nv">transaction_read_only</span><span class="c1">;</span>
<span class="o">-</span>[ <span class="nv">RECORD</span> <span class="mi">1</span> ]<span class="o">---------+----</span>
<span class="nv">transaction_read_only</span> <span class="o">|</span> <span class="nv">off</span>

<span class="nv">SELECT</span> <span class="nv">c</span>.<span class="nv">relname</span>, <span class="nv">count</span><span class="ss">(</span><span class="o">*</span><span class="ss">)</span> <span class="nv">AS</span> <span class="nv">buffers</span>
 <span class="nv">FROM</span> <span class="nv">pg_buffercache</span> <span class="nv">b</span> <span class="nv">INNER</span> <span class="nv">JOIN</span> <span class="nv">pg_class</span> <span class="nv">c</span>
 <span class="nv">ON</span> <span class="nv">b</span>.<span class="nv">relfilenode</span> <span class="o">=</span> <span class="nv">pg_relation_filenode</span><span class="ss">(</span><span class="nv">c</span>.<span class="nv">oid</span><span class="ss">)</span> <span class="nv">AND</span>
 <span class="nv">b</span>.<span class="nv">reldatabase</span> <span class="nv">IN</span> <span class="ss">(</span><span class="mi">0</span>, <span class="ss">(</span><span class="nv">SELECT</span> <span class="nv">oid</span> <span class="nv">FROM</span> <span class="nv">pg_database</span>
 <span class="nv">WHERE</span> <span class="nv">datname</span> <span class="o">=</span> <span class="nv">current_database</span><span class="ss">()))</span>
 <span class="nv">GROUP</span> <span class="nv">BY</span> <span class="nv">c</span>.<span class="nv">relname</span>
 <span class="nv">ORDER</span> <span class="nv">BY</span> <span class="mi">2</span> <span class="nv">DESC</span>
 <span class="nv">LIMIT</span> <span class="mi">10</span><span class="c1">;</span>

           <span class="nv">relname</span>                      <span class="o">|</span> <span class="nv">buffers</span>  
<span class="o">-----------------------+----------+----------+----------</span>
 <span class="nv">pgbench_accounts</span>               <span class="o">|</span> <span class="mi">18182376</span>
 <span class="nv">pgbench_accounts_pkey</span>          <span class="o">|</span>  <span class="mi">2741898</span>
 <span class="nv">pgbench_history</span>                    <span class="o">|</span>    <span class="mi">58807</span>
 <span class="nv">pgbench_tellers</span>                    <span class="o">|</span>     <span class="mi">7286</span>
 <span class="nv">pgbench_branches</span>               <span class="o">|</span>     <span class="mi">5137</span>
 <span class="nv">pgbench_tellers_pkey</span>           <span class="o">|</span>     <span class="mi">2197</span>
 <span class="nv">pgbench_branches_pkey</span>          <span class="o">|</span>     <span class="mi">1130</span>
 <span class="nv">pg_attribute</span>                       <span class="o">|</span>       <span class="mi">30</span>
 <span class="nv">pg_statistic</span>                       <span class="o">|</span>       <span class="mi">24</span>
 <span class="nv">pg_proc</span>                            <span class="o">|</span>       <span class="mi">18</span>
</pre></div>


<p><strong>Connecting to the read replica</strong></p>
<p>a. <a href="https://console.aws.amazon.com/rds/" target="_blank"> Sign in to the AWS Management Console and open the Amazon RDS console</a> .<br>
b.  In the navigation pane, choose Databases and click on the DB identifier with the cluster name you created as a part of the CloudFormation stack.<br>
<span class="image"><img alt="1-ccm-guide-19" src="1-ccm-guide-19.png?raw=true" /></span><br>
c.  Click on the selected cluster above and look under the section “Connectivity and Security”. You will see 2 different endpoints under the “Type” column. The one on the top will be the cluster endpoint (for read-write) and the other one will be reader endpoint (for read-only).
<span class="image"><img alt="1-ccm-guide-20" src="1-ccm-guide-20.png?raw=true" /></span><br>
d.  Choose the Reader Endpoint of the Aurora PostgreSQL Cluster.</p>
<div class="codehilite"><pre><span></span><span class="p">.</span><span class="o">/</span><span class="n">psql</span> <span class="o">-</span><span class="n">h</span>  <span class="n">labstack</span><span class="o">-</span><span class="k">cluster</span><span class="p">.</span><span class="k">cluster</span><span class="o">-</span><span class="n">ro</span><span class="o">-</span><span class="n">xxxxxxxxx</span><span class="p">.</span><span class="n">us</span><span class="o">-</span><span class="n">west</span><span class="o">-</span><span class="mi">2</span><span class="p">.</span><span class="n">rds</span><span class="p">.</span><span class="n">amazonaws</span><span class="p">.</span><span class="n">com</span> <span class="o">-</span><span class="n">p</span> <span class="mi">5432</span> <span class="o">-</span><span class="n">U</span>  <span class="n">masteruser</span> <span class="o">-</span><span class="n">d</span> <span class="n">mylab</span>
</pre></div>


<div class="codehilite"><pre><span></span><span class="nv">ccmdb</span><span class="o">=&gt;</span> \<span class="nv">dx</span> <span class="nv">pg_buffercache</span>
                    <span class="nv">List</span> <span class="nv">of</span> <span class="nv">installed</span> <span class="nv">extensions</span>
      <span class="nv">Name</span>      <span class="o">|</span> <span class="nv">Version</span> <span class="o">|</span> <span class="nv">Schema</span> <span class="o">|</span>           <span class="nv">Description</span>           
<span class="o">----------------+---------+--------+---------------------------------</span>
 <span class="nv">pg_buffercache</span> <span class="o">|</span> <span class="mi">1</span>.<span class="mi">3</span>     <span class="o">|</span> <span class="nv">public</span> <span class="o">|</span> <span class="nv">examine</span> <span class="nv">the</span> <span class="nv">shared</span> <span class="nv">buffer</span> <span class="nv">cache</span>
<span class="ss">(</span><span class="mi">1</span> <span class="nv">row</span><span class="ss">)</span>

<span class="o">--</span> <span class="nv">Verify</span> <span class="k">if</span> <span class="nv">we</span> <span class="nv">are</span> <span class="nv">connected</span> <span class="nv">to</span> <span class="nv">the</span> <span class="nv">Read</span><span class="o">-</span><span class="nv">only</span> <span class="nv">node</span>.

<span class="nv">mylab</span><span class="o">=&gt;</span> <span class="k">show</span> <span class="nv">transaction_read_only</span><span class="c1">;</span>
<span class="o">-</span>[ <span class="nv">RECORD</span> <span class="mi">1</span> ]<span class="o">---------+---</span>
<span class="nv">transaction_read_only</span> <span class="o">|</span> <span class="nv">on</span>

<span class="nv">SELECT</span> <span class="nv">c</span>.<span class="nv">relname</span>, <span class="nv">count</span><span class="ss">(</span><span class="o">*</span><span class="ss">)</span> <span class="nv">AS</span> <span class="nv">buffers</span>
 <span class="nv">FROM</span> <span class="nv">pg_buffercache</span> <span class="nv">b</span> <span class="nv">INNER</span> <span class="nv">JOIN</span> <span class="nv">pg_class</span> <span class="nv">c</span>
 <span class="nv">ON</span> <span class="nv">b</span>.<span class="nv">relfilenode</span> <span class="o">=</span> <span class="nv">pg_relation_filenode</span><span class="ss">(</span><span class="nv">c</span>.<span class="nv">oid</span><span class="ss">)</span> <span class="nv">AND</span>
 <span class="nv">b</span>.<span class="nv">reldatabase</span> <span class="nv">IN</span> <span class="ss">(</span><span class="mi">0</span>, <span class="ss">(</span><span class="nv">SELECT</span> <span class="nv">oid</span> <span class="nv">FROM</span> <span class="nv">pg_database</span>
 <span class="nv">WHERE</span> <span class="nv">datname</span> <span class="o">=</span> <span class="nv">current_database</span><span class="ss">()))</span>
 <span class="nv">GROUP</span> <span class="nv">BY</span> <span class="nv">c</span>.<span class="nv">relname</span>
 <span class="nv">ORDER</span> <span class="nv">BY</span> <span class="mi">2</span> <span class="nv">DESC</span>
 <span class="nv">LIMIT</span> <span class="mi">10</span><span class="c1">;</span>
          <span class="nv">relname</span>                       <span class="o">|</span> <span class="nv">buffers</span>  
<span class="o">-----------------------+----------+----------+----------</span>
 <span class="nv">pgbench_accounts</span>               <span class="o">|</span> <span class="mi">18162144</span>
 <span class="nv">pgbench_accounts_pkey</span>          <span class="o">|</span>  <span class="mi">2741869</span>
 <span class="nv">pgbench_history</span>                    <span class="o">|</span>    <span class="mi">58804</span>
 <span class="nv">pgbench_tellers</span>                    <span class="o">|</span>     <span class="mi">7144</span>
 <span class="nv">pgbench_branches</span>               <span class="o">|</span>     <span class="mi">5028</span>
 <span class="nv">pgbench_tellers_pkey</span>           <span class="o">|</span>     <span class="mi">2156</span>
 <span class="nv">pgbench_branches_pkey</span>          <span class="o">|</span>     <span class="mi">1109</span>
 <span class="nv">pg_attribute</span>                       <span class="o">|</span>       <span class="mi">26</span>
 <span class="nv">pg_statistic</span>                       <span class="o">|</span>       <span class="mi">24</span>
 <span class="nv">pg_operator</span>                        <span class="o">|</span>       <span class="mi">15</span>
</pre></div>


<h3 id="42-collecting-the-pgbench-benchmarking-metrics">4.2 Collecting the pgbench benchmarking metrics.<a class="headerlink" href="#42-collecting-the-pgbench-benchmarking-metrics" title="Permanent link">&para;</a></h3>
<p>We initiated 600 seconds benchmarking on the Aurora PostgreSQL with CCM enabled above using the below command </p>
<div class="codehilite"><pre><span></span><span class="p">.</span><span class="o">/</span><span class="n">pgbench</span>  <span class="o">--</span><span class="n">progress</span><span class="o">-</span><span class="n">timestamp</span> <span class="o">-</span><span class="n">M</span> <span class="n">prepared</span> <span class="o">-</span><span class="n">n</span> <span class="o">-</span><span class="n">T</span> <span class="mi">600</span> <span class="o">-</span><span class="n">P</span> <span class="mi">5</span>  <span class="o">-</span><span class="n">c</span> <span class="mi">50</span> <span class="o">-</span><span class="n">j</span> <span class="mi">50</span>  <span class="o">--</span><span class="n">host</span><span class="o">=</span><span class="n">labstack</span><span class="o">-</span><span class="n">cluster</span><span class="p">.</span><span class="n">cluster</span><span class="o">-</span><span class="n">xxxxxxxxx</span><span class="p">.</span><span class="n">us</span><span class="o">-</span><span class="n">west</span><span class="o">-</span><span class="mf">2.</span><span class="n">rds</span><span class="p">.</span><span class="n">amazonaws</span><span class="p">.</span><span class="n">com</span> <span class="o">-</span><span class="n">b</span> <span class="n">tpcb</span><span class="o">-</span><span class="n">like</span><span class="mi">@1</span> <span class="o">-</span><span class="n">b</span> <span class="n">select</span><span class="o">-</span><span class="n">only</span><span class="mi">@20</span> <span class="o">--</span><span class="n">username</span><span class="o">=</span><span class="n">masteruser</span> <span class="n">mylab</span><span class="o">&gt;</span> <span class="n">ccm_enable_before_failover</span><span class="p">.</span><span class="k">out</span> 
</pre></div>


<p>After 600 seconds once, the benchmark is completed you can verify the pgbench output on the screen (on the psql console) or can refer the output file “ccm_enable_before_failover.out”. The summary output at the bottom will look like below. Please note that the output may be little bit different in your case.</p>
<div class="codehilite"><pre><span></span><span class="n">transaction</span> <span class="k">type</span><span class="p">:</span> <span class="n">multiple</span> <span class="n">scripts</span>
<span class="n">scaling</span> <span class="n">factor</span><span class="p">:</span> <span class="mi">10000</span>
<span class="n">query</span> <span class="k">mode</span><span class="p">:</span> <span class="n">prepared</span>
<span class="nb">number</span> <span class="k">of</span> <span class="n">clients</span><span class="p">:</span> <span class="mi">500</span>
<span class="nb">number</span> <span class="k">of</span> <span class="n">threads</span><span class="p">:</span> <span class="mi">500</span>
<span class="n">duration</span><span class="p">:</span> <span class="mi">600</span> <span class="n">s</span>
<span class="nb">number</span> <span class="k">of</span> <span class="n">transactions</span> <span class="n">actually</span> <span class="n">processed</span><span class="p">:</span> <span class="mi">192341828</span>
<span class="n">latency</span> <span class="n">average</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="mi">558</span> <span class="n">ms</span>
<span class="n">latency</span> <span class="n">stddev</span> <span class="o">=</span> <span class="mi">3</span><span class="p">.</span><span class="mi">434</span> <span class="n">ms</span>
<span class="n">tps</span> <span class="o">=</span> <span class="mi">320517</span><span class="p">.</span><span class="mi">529436</span> <span class="p">(</span><span class="k">including</span> <span class="n">connections</span> <span class="n">establishing</span><span class="p">)</span>
<span class="n">tps</span> <span class="o">=</span> <span class="mi">320766</span><span class="p">.</span><span class="mi">435473</span> <span class="p">(</span><span class="k">excluding</span> <span class="n">connections</span> <span class="n">establishing</span><span class="p">)</span>
<span class="k">SQL</span> <span class="n">script</span> <span class="mi">1</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">builtin</span><span class="p">:</span> <span class="n">TPC</span><span class="o">-</span><span class="n">B</span> <span class="p">(</span><span class="n">sort</span> <span class="k">of</span><span class="p">)</span><span class="o">&gt;</span>
 <span class="o">-</span> <span class="n">weight</span><span class="p">:</span> <span class="mi">1</span> <span class="p">(</span><span class="n">targets</span> <span class="mi">4</span><span class="p">.</span><span class="mi">8</span><span class="o">%</span> <span class="k">of</span> <span class="n">total</span><span class="p">)</span>
 <span class="o">-</span> <span class="mi">9121117</span> <span class="n">transactions</span> <span class="p">(</span><span class="mi">4</span><span class="p">.</span><span class="mi">7</span><span class="o">%</span> <span class="k">of</span> <span class="n">total</span><span class="p">,</span> <span class="n">tps</span> <span class="o">=</span> <span class="mi">15199</span><span class="p">.</span><span class="mi">387034</span><span class="p">)</span>
 <span class="o">-</span> <span class="n">latency</span> <span class="n">average</span> <span class="o">=</span> <span class="mi">15</span><span class="p">.</span><span class="mi">840</span> <span class="n">ms</span>
 <span class="o">-</span> <span class="n">latency</span> <span class="n">stddev</span> <span class="o">=</span> <span class="mi">5</span><span class="p">.</span><span class="mi">073</span> <span class="n">ms</span>
<span class="k">SQL</span> <span class="n">script</span> <span class="mi">2</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">builtin</span><span class="p">:</span> <span class="k">select</span> <span class="k">only</span><span class="o">&gt;</span>
 <span class="o">-</span> <span class="n">weight</span><span class="p">:</span> <span class="mi">20</span> <span class="p">(</span><span class="n">targets</span> <span class="mi">95</span><span class="p">.</span><span class="mi">2</span><span class="o">%</span> <span class="k">of</span> <span class="n">total</span><span class="p">)</span>
 <span class="o">-</span> <span class="mi">179708569</span> <span class="n">transactions</span> <span class="p">(</span><span class="mi">93</span><span class="p">.</span><span class="mi">4</span><span class="o">%</span> <span class="k">of</span> <span class="n">total</span><span class="p">,</span> <span class="n">tps</span> <span class="o">=</span> <span class="mi">299465</span><span class="p">.</span><span class="mi">525275</span><span class="p">)</span>
 <span class="o">-</span> <span class="n">latency</span> <span class="n">average</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">851</span> <span class="n">ms</span>
 <span class="o">-</span> <span class="n">latency</span> <span class="n">stddev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">613</span> <span class="n">ms</span>
</pre></div>


<h3 id="43-ccm-enabled-failover-benchmarking">4.3 CCM enabled failover benchmarking<a class="headerlink" href="#43-ccm-enabled-failover-benchmarking" title="Permanent link">&para;</a></h3>
<p>We are Initiating the failover from the console after 600 seconds and running the same workload once the failover is completed. For initiating the failover please go the RDS console, select your cluster and click on the writer instance and go the actions and click “Failover”.
<span class="image"><img alt="1-ccm-guide-21" src="1-ccm-guide-21.png?raw=true" /></span><br>
<span class="image"><img alt="1-ccm-guide-22" src="1-ccm-guide-22.png?raw=true" /></span><br></p>
<p>Once the failover is completed after about ~30 seconds. Verify the previous reader instance becomes the new writer.
<span class="image"><img alt="1-ccm-guide-23" src="1-ccm-guide-23.png?raw=true" /></span><br>
We will be running the same benchmarking as we did before the failover and then we will compare the pgbench metrics before and after the failover.</p>
<div class="codehilite"><pre><span></span><span class="p">.</span><span class="o">/</span><span class="n">pgbench</span>  <span class="o">--</span><span class="n">progress</span><span class="o">-</span><span class="n">timestamp</span> <span class="o">-</span><span class="n">M</span> <span class="n">prepared</span> <span class="o">-</span><span class="n">n</span> <span class="o">-</span><span class="n">T</span> <span class="mi">600</span> <span class="o">-</span><span class="n">P</span> <span class="mi">5</span>  <span class="o">-</span><span class="n">c</span> <span class="mi">50</span> <span class="o">-</span><span class="n">j</span> <span class="mi">50</span>  <span class="o">--</span><span class="n">host</span><span class="o">=</span><span class="n">labstack</span><span class="o">-</span><span class="n">cluster</span><span class="p">.</span><span class="n">cluster</span><span class="o">-</span><span class="n">xxxxxxxxx</span><span class="p">.</span><span class="n">us</span><span class="o">-</span><span class="n">west</span><span class="o">-</span><span class="mf">2.</span><span class="n">rds</span><span class="p">.</span><span class="n">amazonaws</span><span class="p">.</span><span class="n">com</span> <span class="o">-</span><span class="n">b</span> <span class="n">tpcb</span><span class="o">-</span><span class="n">like</span><span class="mi">@1</span> <span class="o">-</span><span class="n">b</span> <span class="n">select</span><span class="o">-</span><span class="n">only</span><span class="mi">@20</span> <span class="o">--</span><span class="n">username</span><span class="o">=</span><span class="n">masteruser</span> <span class="n">mylab</span><span class="o">&gt;</span> <span class="n">ccm_enable_after_failover</span><span class="p">.</span><span class="k">out</span>
</pre></div>


<p>After 600 seconds once, the benchmark is completed you can verify the pgbench output on the screen (on the psql console) or can refer the output file “ccm_enable_after_failover.out”. The summary output at the bottom will look like below. Please note that the output may be little bit different in your case.</p>
<div class="codehilite"><pre><span></span><span class="n">transaction</span> <span class="k">type</span><span class="p">:</span> <span class="n">multiple</span> <span class="n">scripts</span>
<span class="n">scaling</span> <span class="n">factor</span><span class="p">:</span> <span class="mi">10000</span>
<span class="n">query</span> <span class="k">mode</span><span class="p">:</span> <span class="n">prepared</span>
<span class="nb">number</span> <span class="k">of</span> <span class="n">clients</span><span class="p">:</span> <span class="mi">500</span>
<span class="nb">number</span> <span class="k">of</span> <span class="n">threads</span><span class="p">:</span> <span class="mi">500</span>
<span class="n">duration</span><span class="p">:</span> <span class="mi">600</span> <span class="n">s</span>
<span class="nb">number</span> <span class="k">of</span> <span class="n">transactions</span> <span class="n">actually</span> <span class="n">processed</span><span class="p">:</span> <span class="mi">190891585</span>
<span class="n">latency</span> <span class="n">average</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="mi">570</span> <span class="n">ms</span>
<span class="n">latency</span> <span class="n">stddev</span> <span class="o">=</span> <span class="mi">3</span><span class="p">.</span><span class="mi">624</span> <span class="n">ms</span>
<span class="n">tps</span> <span class="o">=</span> <span class="mi">318119</span><span class="p">.</span><span class="mi">106352</span> <span class="p">(</span><span class="k">including</span> <span class="n">connections</span> <span class="n">establishing</span><span class="p">)</span>
<span class="n">tps</span> <span class="o">=</span> <span class="mi">318350</span><span class="p">.</span><span class="mi">153525</span> <span class="p">(</span><span class="k">excluding</span> <span class="n">connections</span> <span class="n">establishing</span><span class="p">)</span>
<span class="k">SQL</span> <span class="n">script</span> <span class="mi">1</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">builtin</span><span class="p">:</span> <span class="n">TPC</span><span class="o">-</span><span class="n">B</span> <span class="p">(</span><span class="n">sort</span> <span class="k">of</span><span class="p">)</span><span class="o">&gt;</span>
 <span class="o">-</span> <span class="n">weight</span><span class="p">:</span> <span class="mi">1</span> <span class="p">(</span><span class="n">targets</span> <span class="mi">4</span><span class="p">.</span><span class="mi">8</span><span class="o">%</span> <span class="k">of</span> <span class="n">total</span><span class="p">)</span>
 <span class="o">-</span> <span class="mi">9053479</span> <span class="n">transactions</span> <span class="p">(</span><span class="mi">4</span><span class="p">.</span><span class="mi">7</span><span class="o">%</span> <span class="k">of</span> <span class="n">total</span><span class="p">,</span> <span class="n">tps</span> <span class="o">=</span> <span class="mi">15087</span><span class="p">.</span><span class="mi">541176</span><span class="p">)</span>
 <span class="o">-</span> <span class="n">latency</span> <span class="n">average</span> <span class="o">=</span> <span class="mi">16</span><span class="p">.</span><span class="mi">704</span> <span class="n">ms</span>
 <span class="o">-</span> <span class="n">latency</span> <span class="n">stddev</span> <span class="o">=</span> <span class="mi">5</span><span class="p">.</span><span class="mi">387</span> <span class="n">ms</span>
<span class="k">SQL</span> <span class="n">script</span> <span class="mi">2</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">builtin</span><span class="p">:</span> <span class="k">select</span> <span class="k">only</span><span class="o">&gt;</span>
 <span class="o">-</span> <span class="n">weight</span><span class="p">:</span> <span class="mi">20</span> <span class="p">(</span><span class="n">targets</span> <span class="mi">95</span><span class="p">.</span><span class="mi">2</span><span class="o">%</span> <span class="k">of</span> <span class="n">total</span><span class="p">)</span>
 <span class="o">-</span> <span class="mi">178217587</span> <span class="n">transactions</span> <span class="p">(</span><span class="mi">93</span><span class="p">.</span><span class="mi">4</span><span class="o">%</span> <span class="k">of</span> <span class="n">total</span><span class="p">,</span> <span class="n">tps</span> <span class="o">=</span> <span class="mi">296998</span><span class="p">.</span><span class="mi">002885</span><span class="p">)</span>
 <span class="o">-</span> <span class="n">latency</span> <span class="n">average</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">821</span> <span class="n">ms</span>
 <span class="o">-</span> <span class="n">latency</span> <span class="n">stddev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">560</span> <span class="n">ms</span>
</pre></div>


<h3 id="44-benchmarking-on-ccm-disabled-cluster">4.4 Benchmarking on CCM disabled cluster<a class="headerlink" href="#44-benchmarking-on-ccm-disabled-cluster" title="Permanent link">&para;</a></h3>
<p><strong> Disabling the CCM</strong></p>
<ol>
<li>Disable the CCM on the Aurora PostgreSQL cluster by modifying the cluster parameter group file as show as above and set the value of the apg_ccm_enabled cluster parameter to 0.</li>
<li>Modify the Amazon Aurora DB Cluster Parameters related to the CCM. Screenshots of some of the steps are shown below
a. <a href="https://console.aws.amazon.com/rds/" target="_blank"> Sign in to the AWS Management Console and open the Amazon RDS console</a> .
b. In the navigation pane, choose Parameter groups.
<span class="image"><img alt="1-ccm-guide-24" src="1-ccm-guide-24.png?raw=true" /></span><br>
c.  In the list, choose the parameter group for your Aurora PostgreSQL DB cluster.  Please refer the name of the DB cluster parameter group file created from the output section of the CloudFormation Stack. It is in the format <stack-name-apgcustom-clusterparamgroup-nnnn>. In this case the stack name is “labstack” and hence the DB cluster parameter group file is “labstack- apgcustom-clusterparamgroup-nnnn &gt;. The DB cluster must use a parameter group other than the default, because you can't change values in a default parameter group.
For more information ,<a href="https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/USER_WorkingWithParamGroups.html#USER_WorkingWithParamGroups.CreatingCluster" target="_blank"> see Creating a DB Cluster Parameter Group</a>.
<span class="image"><img alt="1-ccm-guide-25" src="1-ccm-guide-25.png?raw=true" /></span><br>
d.  Click on the DB cluster parameter group selected above and then click on “Edit Parameters”
<span class="image"><img alt="1-ccm-guide-26" src="1-ccm-guide-26.png?raw=true" /></span><br>
e.  Set the value of the apg_ccm_enabled cluster parameter to 0 and click on “Save changes” 
<span class="image"><img alt="1-ccm-guide-27" src="1-ccm-guide-27.png?raw=true" /></span><br></li>
<li>Verify if the Cluster Cache Management is disabled, query the function aurora_ccm_status() as shown below</li>
</ol>
<div class="codehilite"><pre><span></span><span class="n">mylab</span><span class="o">=&gt;</span> <span class="err">\</span><span class="n">x</span>
<span class="n">Expanded</span> <span class="n">display</span> <span class="k">is</span> <span class="k">on</span><span class="p">.</span>
<span class="n">mylab</span><span class="o">=&gt;</span> <span class="k">select</span> <span class="o">*</span> <span class="k">from</span> <span class="n">aurora_ccm_status</span><span class="p">();</span>
<span class="n">ERROR</span><span class="p">:</span>  <span class="k">Cluster</span> <span class="k">Cache</span> <span class="n">Manager</span> <span class="k">is</span> <span class="n">disabled</span>
<span class="n">mylab</span><span class="o">=&gt;</span>
</pre></div>


<ol>
<li>Stop and Start the Aurora PostgreSQL cluster
Since we are using the same Aurora PostgreSQL cluster to the testing for the with CCM (enabled and disabled) and since earlier testing with CCM already warmed the buffer cache of the read and write Instance. Therefore, we are stopping and starting the cluster before running the benchmarking. 
We could also reboot both the reader and the writer Instance, but this may not guarantee that the writer and reader come up with empty buffer cache.
<strong>To stop the cluster</strong></li>
</ol>
<p>Verify the cluster status is shown as “Available”, then  click on the Actions and choose “stop”
<span class="image"><img alt="1-ccm-guide-28" src="1-ccm-guide-28.png?raw=true" /></span><br>
<strong>To start the cluster</strong>
Once the cluster status changes to” stop”, click on the Actions and choose “start”
<span class="image"><img alt="1-ccm-guide-29" src="1-ccm-guide-29.png?raw=true" /></span><br></p>
<p><strong>Running the benchwork</strong>
We are using <a href="https://www.postgresql.org/docs/10/pgbench.html" target="_blank">pgbench </a>  benchmarking option tpcb-like and using “@” to specify the probability of running read-only workload and read-write workload. In the below example we are running tpcb-like workload with 20X read-only workload and 1x read-write workload for 600 seconds.</p>
<div class="codehilite"><pre><span></span><span class="p">.</span><span class="o">/</span><span class="n">pgbench</span>  <span class="o">--</span><span class="n">progress</span><span class="o">-</span><span class="n">timestamp</span> <span class="o">-</span><span class="n">M</span> <span class="n">prepared</span> <span class="o">-</span><span class="n">n</span> <span class="o">-</span><span class="n">T</span> <span class="mi">600</span> <span class="o">-</span><span class="n">P</span> <span class="mi">5</span>  <span class="o">-</span><span class="n">c</span> <span class="mi">50</span> <span class="o">-</span><span class="n">j</span> <span class="mi">50</span>  <span class="o">--</span><span class="n">host</span><span class="o">=</span><span class="n">labstack</span><span class="o">-</span><span class="n">cluster</span><span class="p">.</span><span class="n">cluster</span><span class="o">-</span><span class="n">xxxxxxxxx</span><span class="p">.</span><span class="n">us</span><span class="o">-</span><span class="n">west</span><span class="o">-</span><span class="mf">2.</span><span class="n">rds</span><span class="p">.</span><span class="n">amazonaws</span><span class="p">.</span><span class="n">com</span> <span class="o">-</span><span class="n">b</span> <span class="n">tpcb</span><span class="o">-</span><span class="n">like</span><span class="mi">@1</span> <span class="o">-</span><span class="n">b</span> <span class="n">select</span><span class="o">-</span><span class="n">only</span><span class="mi">@20</span> <span class="o">--</span><span class="n">username</span><span class="o">=</span><span class="n">masteruser</span> <span class="n">mylab</span><span class="o">&gt;</span> <span class="n">ccm_disable_before_failover</span><span class="p">.</span><span class="k">out</span>
</pre></div>


<h3 id="45-using-pg_buffercache-ccm-disabled">4.5. Using pg_buffercache (CCM disabled)<a class="headerlink" href="#45-using-pg_buffercache-ccm-disabled" title="Permanent link">&para;</a></h3>
<p><strong>Connect to the Writer node using the cluster endpoint of your cluster.</strong></p>
<p>a. <a href="https://console.aws.amazon.com/rds/" target="_blank"> Sign in to the AWS Management Console and open the Amazon RDS console</a> . <br>
b. In the navigation pane, choose Databases and click on the DB identifier with the cluster name you created as a part of the CloudFormation stack.
<span class="image"><img alt="1-ccm-guide-30" src="1-ccm-guide-30.png?raw=true" /></span><br>
c. Click on the selected cluster above and look under the section “Connectivity and Security”. You will see 2 different endpoints under the “Type” column. The one on the top will be the cluster endpoint (for read-write) and the other one will be reader endpoint (for read-only).
<span class="image"><img alt="1-ccm-guide-31" src="1-ccm-guide-31.png?raw=true" /></span><br>
d. Choose the Writer Endpoint of the Aurora PostgreSQL Cluster.</p>
<div class="codehilite"><pre><span></span><span class="p">.</span><span class="o">/</span><span class="n">psql</span> <span class="o">-</span><span class="n">h</span>  <span class="n">labstack</span><span class="o">-</span><span class="k">cluster</span><span class="p">.</span><span class="k">cluster</span><span class="o">-</span><span class="n">xxxxxxxxx</span><span class="p">.</span><span class="n">us</span><span class="o">-</span><span class="n">west</span><span class="o">-</span><span class="mi">2</span><span class="p">.</span><span class="n">rds</span><span class="p">.</span><span class="n">amazonaws</span><span class="p">.</span><span class="n">com</span> <span class="o">-</span><span class="n">p</span> <span class="mi">5432</span> <span class="o">-</span><span class="n">U</span>  <span class="n">masteruser</span> <span class="o">-</span><span class="n">d</span> <span class="n">mylab</span>
</pre></div>


<div class="codehilite"><pre><span></span><span class="nv">mylab</span><span class="o">=&gt;</span> \<span class="nv">dx</span> <span class="nv">pg_buffercache</span>
                    <span class="nv">List</span> <span class="nv">of</span> <span class="nv">installed</span> <span class="nv">extensions</span>
      <span class="nv">Name</span>      <span class="o">|</span> <span class="nv">Version</span> <span class="o">|</span> <span class="nv">Schema</span> <span class="o">|</span>           <span class="nv">Description</span>           
<span class="o">----------------+---------+--------+---------------------------------</span>
 <span class="nv">pg_buffercache</span> <span class="o">|</span> <span class="mi">1</span>.<span class="mi">3</span>     <span class="o">|</span> <span class="nv">public</span> <span class="o">|</span> <span class="nv">examine</span> <span class="nv">the</span> <span class="nv">shared</span> <span class="nv">buffer</span> <span class="nv">cache</span>
<span class="ss">(</span><span class="mi">1</span> <span class="nv">row</span><span class="ss">)</span>


<span class="o">--</span> <span class="nv">Verify</span> <span class="k">if</span> <span class="nv">we</span> <span class="nv">are</span> <span class="nv">connected</span> <span class="nv">to</span> <span class="nv">the</span> <span class="nv">Writer</span> <span class="nv">node</span>.

<span class="nv">ccmdb</span><span class="o">=&gt;</span> <span class="k">show</span> <span class="nv">transaction_read_only</span><span class="c1">;</span>
<span class="o">-</span>[ <span class="nv">RECORD</span> <span class="mi">1</span> ]<span class="o">---------+----</span>
<span class="nv">transaction_read_only</span> <span class="o">|</span> <span class="nv">off</span>

<span class="nv">SELECT</span> <span class="nv">c</span>.<span class="nv">relname</span>, <span class="nv">count</span><span class="ss">(</span><span class="o">*</span><span class="ss">)</span> <span class="nv">AS</span> <span class="nv">buffers</span>
 <span class="nv">FROM</span> <span class="nv">pg_buffercache</span> <span class="nv">b</span> <span class="nv">INNER</span> <span class="nv">JOIN</span> <span class="nv">pg_class</span> <span class="nv">c</span>
 <span class="nv">ON</span> <span class="nv">b</span>.<span class="nv">relfilenode</span> <span class="o">=</span> <span class="nv">pg_relation_filenode</span><span class="ss">(</span><span class="nv">c</span>.<span class="nv">oid</span><span class="ss">)</span> <span class="nv">AND</span>
 <span class="nv">b</span>.<span class="nv">reldatabase</span> <span class="nv">IN</span> <span class="ss">(</span><span class="mi">0</span>, <span class="ss">(</span><span class="nv">SELECT</span> <span class="nv">oid</span> <span class="nv">FROM</span> <span class="nv">pg_database</span>
 <span class="nv">WHERE</span> <span class="nv">datname</span> <span class="o">=</span> <span class="nv">current_database</span><span class="ss">()))</span>
 <span class="nv">GROUP</span> <span class="nv">BY</span> <span class="nv">c</span>.<span class="nv">relname</span>
 <span class="nv">ORDER</span> <span class="nv">BY</span> <span class="mi">2</span> <span class="nv">DESC</span>
 <span class="nv">LIMIT</span> <span class="mi">10</span><span class="c1">;</span>

           <span class="nv">relname</span>                      <span class="o">|</span> <span class="nv">buffers</span>  
<span class="o">-----------------------+----------+----------+----------</span>
         <span class="nv">relname</span>                        <span class="o">|</span> <span class="nv">buffers</span>  
<span class="o">-----------------------+----------+----------+----------</span>
 <span class="nv">pgbench_accounts</span>               <span class="o">|</span> <span class="mi">15401635</span>
 <span class="nv">pgbench_accounts_pkey</span>          <span class="o">|</span>  <span class="mi">2741889</span>
 <span class="nv">pgbench_history</span>                    <span class="o">|</span>    <span class="mi">17024</span>
 <span class="nv">pgbench_tellers</span>                    <span class="o">|</span>     <span class="mi">4992</span>
 <span class="nv">pgbench_branches</span>               <span class="o">|</span>     <span class="mi">3647</span>
 <span class="nv">pgbench_tellers_pkey</span>           <span class="o">|</span>     <span class="mi">2200</span>
 <span class="nv">pgbench_branches_pkey</span>          <span class="o">|</span>      <span class="mi">930</span>
 <span class="nv">pg_attribute</span>                       <span class="o">|</span>       <span class="mi">31</span>
 <span class="nv">pg_statistic</span>                       <span class="o">|</span>       <span class="mi">20</span>
 <span class="nv">pg_proc</span>                            <span class="o">|</span>       <span class="mi">20</span>
<span class="ss">(</span><span class="mi">10</span> <span class="nv">rows</span><span class="ss">)</span>
</pre></div>


<p><strong>Connect to the read replica</strong></p>
<p>a. <a href="https://console.aws.amazon.com/rds/" target="_blank"> Sign in to the AWS Management Console and open the Amazon RDS console</a> . <br></p>
<p>b. In the navigation pane, choose Databases and click on the DB identifier with the cluster name you created as a part of the CloudFormation stack.
<span class="image"><img alt="1-ccm-guide-32" src="1-ccm-guide-32.png?raw=true" /></span><br>
c.  Click on the selected cluster above and look under the section “Connectivity and Security”. You will see 2 different endpoints under the “Type” column. The one on the top will be the cluster endpoint (for read-write) and the other one will be reader endpoint (for read-only).
<span class="image"><img alt="1-ccm-guide-33" src="1-ccm-guide-33.png?raw=true" /></span><br>
d. Choose the Reader Endpoint of the Aurora PostgreSQL Cluster.</p>
<div class="codehilite"><pre><span></span><span class="p">.</span><span class="o">/</span><span class="n">psql</span> <span class="o">-</span><span class="n">h</span>  <span class="n">labstack</span><span class="o">-</span><span class="k">cluster</span><span class="p">.</span><span class="k">cluster</span><span class="o">-</span><span class="n">ro</span><span class="o">-</span><span class="n">xxxxxxxxx</span><span class="p">.</span><span class="n">us</span><span class="o">-</span><span class="n">west</span><span class="o">-</span><span class="mi">2</span><span class="p">.</span><span class="n">rds</span><span class="p">.</span><span class="n">amazonaws</span><span class="p">.</span><span class="n">com</span> <span class="o">-</span><span class="n">p</span> <span class="mi">5432</span> <span class="o">-</span><span class="n">U</span>  <span class="n">masteruser</span> <span class="o">-</span><span class="n">d</span> <span class="n">mylab</span>
</pre></div>


<div class="codehilite"><pre><span></span><span class="nv">ccmdb</span><span class="o">=&gt;</span> \<span class="nv">dx</span> <span class="nv">pg_buffercache</span>
                    <span class="nv">List</span> <span class="nv">of</span> <span class="nv">installed</span> <span class="nv">extensions</span>
      <span class="nv">Name</span>      <span class="o">|</span> <span class="nv">Version</span> <span class="o">|</span> <span class="nv">Schema</span> <span class="o">|</span>           <span class="nv">Description</span>           
<span class="o">----------------+---------+--------+---------------------------------</span>
 <span class="nv">pg_buffercache</span> <span class="o">|</span> <span class="mi">1</span>.<span class="mi">3</span>     <span class="o">|</span> <span class="nv">public</span> <span class="o">|</span> <span class="nv">examine</span> <span class="nv">the</span> <span class="nv">shared</span> <span class="nv">buffer</span> <span class="nv">cache</span>
<span class="ss">(</span><span class="mi">1</span> <span class="nv">row</span><span class="ss">)</span>

<span class="o">--</span> <span class="nv">Verify</span> <span class="k">if</span> <span class="nv">we</span> <span class="nv">are</span> <span class="nv">connected</span> <span class="nv">to</span> <span class="nv">the</span> <span class="nv">Read</span><span class="o">-</span><span class="nv">only</span> <span class="nv">node</span>.

<span class="nv">mylab</span><span class="o">=&gt;</span> <span class="k">show</span> <span class="nv">transaction_read_only</span><span class="c1">;</span>
<span class="o">-</span>[ <span class="nv">RECORD</span> <span class="mi">1</span> ]<span class="o">---------+---</span>
<span class="nv">transaction_read_only</span> <span class="o">|</span> <span class="nv">on</span>

<span class="nv">SELECT</span> <span class="nv">c</span>.<span class="nv">relname</span>, <span class="nv">count</span><span class="ss">(</span><span class="o">*</span><span class="ss">)</span> <span class="nv">AS</span> <span class="nv">buffers</span>
 <span class="nv">FROM</span> <span class="nv">pg_buffercache</span> <span class="nv">b</span> <span class="nv">INNER</span> <span class="nv">JOIN</span> <span class="nv">pg_class</span> <span class="nv">c</span>
 <span class="nv">ON</span> <span class="nv">b</span>.<span class="nv">relfilenode</span> <span class="o">=</span> <span class="nv">pg_relation_filenode</span><span class="ss">(</span><span class="nv">c</span>.<span class="nv">oid</span><span class="ss">)</span> <span class="nv">AND</span>
 <span class="nv">b</span>.<span class="nv">reldatabase</span> <span class="nv">IN</span> <span class="ss">(</span><span class="mi">0</span>, <span class="ss">(</span><span class="nv">SELECT</span> <span class="nv">oid</span> <span class="nv">FROM</span> <span class="nv">pg_database</span>
 <span class="nv">WHERE</span> <span class="nv">datname</span> <span class="o">=</span> <span class="nv">current_database</span><span class="ss">()))</span>
 <span class="nv">GROUP</span> <span class="nv">BY</span> <span class="nv">c</span>.<span class="nv">relname</span>
 <span class="nv">ORDER</span> <span class="nv">BY</span> <span class="mi">2</span> <span class="nv">DESC</span>
 <span class="nv">LIMIT</span> <span class="mi">10</span><span class="c1">;</span>
          <span class="nv">relname</span>                       <span class="o">|</span> <span class="nv">buffers</span>  
<span class="o">-----------------------+----------+----------+----------</span>
<span class="nv">pgbench_history</span>                             <span class="o">|</span>   <span class="mi">11905</span>
 <span class="nv">pg_attribute</span>                               <span class="o">|</span>      <span class="mi">26</span>
 <span class="nv">pg_class</span>                                   <span class="o">|</span>      <span class="mi">11</span>
 <span class="nv">pg_proc</span>                                    <span class="o">|</span>      <span class="mi">10</span>
 <span class="nv">pg_proc_oid_index</span>                      <span class="o">|</span>       <span class="mi">8</span>
 <span class="nv">pg_attribute_relid_attnum_index</span>    <span class="o">|</span>       <span class="mi">7</span>
 <span class="nv">pg_proc_proname_args_nsp_index</span>     <span class="o">|</span>       <span class="mi">5</span>
 <span class="nv">pg_index</span>                                   <span class="o">|</span>       <span class="mi">4</span>
 <span class="nv">pg_amproc</span>                                  <span class="o">|</span>       <span class="mi">4</span>
 <span class="nv">pg_class_relname_nsp_index</span>             <span class="o">|</span>       <span class="mi">4</span>
<span class="ss">(</span><span class="mi">10</span> <span class="nv">rows</span><span class="ss">)</span>
</pre></div>


<p>Collecting the 600 seconds pgbench benchmarking metrics.</p>
<p>We initiated 600 seconds benchmarking on the Aurora PostgreSQL with CCM enabled above using the below command </p>
<div class="codehilite"><pre><span></span><span class="p">.</span><span class="o">/</span><span class="n">pgbench</span>  <span class="o">--</span><span class="n">progress</span><span class="o">-</span><span class="n">timestamp</span> <span class="o">-</span><span class="n">M</span> <span class="n">prepared</span> <span class="o">-</span><span class="n">n</span> <span class="o">-</span><span class="n">T</span> <span class="mi">600</span> <span class="o">-</span><span class="n">P</span> <span class="mi">5</span>  <span class="o">-</span><span class="n">c</span> <span class="mi">50</span> <span class="o">-</span><span class="n">j</span> <span class="mi">50</span>  <span class="o">--</span><span class="n">host</span><span class="o">=</span><span class="n">labstack</span><span class="o">-</span><span class="n">cluster</span><span class="p">.</span><span class="n">cluster</span><span class="o">-</span><span class="n">xxxxxxxxx</span><span class="p">.</span><span class="n">us</span><span class="o">-</span><span class="n">west</span><span class="o">-</span><span class="mf">2.</span><span class="n">rds</span><span class="p">.</span><span class="n">amazonaws</span><span class="p">.</span><span class="n">com</span> <span class="o">-</span><span class="n">b</span> <span class="n">tpcb</span><span class="o">-</span><span class="n">like</span><span class="mi">@1</span> <span class="o">-</span><span class="n">b</span> <span class="n">select</span><span class="o">-</span><span class="n">only</span><span class="mi">@20</span> <span class="o">--</span><span class="n">username</span><span class="o">=</span><span class="n">masteruser</span> <span class="n">mylab</span><span class="o">&gt;</span> <span class="n">ccm_disable_before_failover</span><span class="p">.</span><span class="k">out</span> 
</pre></div>


<p>After 600 seconds once, the benchmark is completed you can verify the pgbench output on the screen (on the psql console) or can refer the output file “ccm_disable_before_failover.out”. The summary output at the bottom will look like below. Please note that the output may be little bit different in your case.</p>
<div class="codehilite"><pre><span></span><span class="n">transaction</span> <span class="k">type</span><span class="p">:</span> <span class="n">multiple</span> <span class="n">scripts</span>
<span class="n">scaling</span> <span class="n">factor</span><span class="p">:</span> <span class="mi">10000</span>
<span class="n">query</span> <span class="k">mode</span><span class="p">:</span> <span class="n">prepared</span>
<span class="nb">number</span> <span class="k">of</span> <span class="n">clients</span><span class="p">:</span> <span class="mi">500</span>
<span class="nb">number</span> <span class="k">of</span> <span class="n">threads</span><span class="p">:</span> <span class="mi">500</span>
<span class="n">duration</span><span class="p">:</span> <span class="mi">600</span> <span class="n">s</span>
<span class="nb">number</span> <span class="k">of</span> <span class="n">transactions</span> <span class="n">actually</span> <span class="n">processed</span><span class="p">:</span> <span class="mi">192341828</span>
<span class="n">latency</span> <span class="n">average</span> <span class="o">=</span> <span class="mi">1</span><span class="p">.</span><span class="mi">558</span> <span class="n">ms</span>
<span class="n">latency</span> <span class="n">stddev</span> <span class="o">=</span> <span class="mi">3</span><span class="p">.</span><span class="mi">434</span> <span class="n">ms</span>
<span class="n">tps</span> <span class="o">=</span> <span class="mi">320517</span><span class="p">.</span><span class="mi">529436</span> <span class="p">(</span><span class="k">including</span> <span class="n">connections</span> <span class="n">establishing</span><span class="p">)</span>
<span class="n">tps</span> <span class="o">=</span> <span class="mi">320766</span><span class="p">.</span><span class="mi">435473</span> <span class="p">(</span><span class="k">excluding</span> <span class="n">connections</span> <span class="n">establishing</span><span class="p">)</span>
<span class="k">SQL</span> <span class="n">script</span> <span class="mi">1</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">builtin</span><span class="p">:</span> <span class="n">TPC</span><span class="o">-</span><span class="n">B</span> <span class="p">(</span><span class="n">sort</span> <span class="k">of</span><span class="p">)</span><span class="o">&gt;</span>
 <span class="o">-</span> <span class="n">weight</span><span class="p">:</span> <span class="mi">1</span> <span class="p">(</span><span class="n">targets</span> <span class="mi">4</span><span class="p">.</span><span class="mi">8</span><span class="o">%</span> <span class="k">of</span> <span class="n">total</span><span class="p">)</span>
 <span class="o">-</span> <span class="mi">9121117</span> <span class="n">transactions</span> <span class="p">(</span><span class="mi">4</span><span class="p">.</span><span class="mi">7</span><span class="o">%</span> <span class="k">of</span> <span class="n">total</span><span class="p">,</span> <span class="n">tps</span> <span class="o">=</span> <span class="mi">15199</span><span class="p">.</span><span class="mi">387034</span><span class="p">)</span>
 <span class="o">-</span> <span class="n">latency</span> <span class="n">average</span> <span class="o">=</span> <span class="mi">15</span><span class="p">.</span><span class="mi">840</span> <span class="n">ms</span>
 <span class="o">-</span> <span class="n">latency</span> <span class="n">stddev</span> <span class="o">=</span> <span class="mi">5</span><span class="p">.</span><span class="mi">073</span> <span class="n">ms</span>
<span class="k">SQL</span> <span class="n">script</span> <span class="mi">2</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">builtin</span><span class="p">:</span> <span class="k">select</span> <span class="k">only</span><span class="o">&gt;</span>
 <span class="o">-</span> <span class="n">weight</span><span class="p">:</span> <span class="mi">20</span> <span class="p">(</span><span class="n">targets</span> <span class="mi">95</span><span class="p">.</span><span class="mi">2</span><span class="o">%</span> <span class="k">of</span> <span class="n">total</span><span class="p">)</span>
 <span class="o">-</span> <span class="mi">179708569</span> <span class="n">transactions</span> <span class="p">(</span><span class="mi">93</span><span class="p">.</span><span class="mi">4</span><span class="o">%</span> <span class="k">of</span> <span class="n">total</span><span class="p">,</span> <span class="n">tps</span> <span class="o">=</span> <span class="mi">299465</span><span class="p">.</span><span class="mi">525275</span><span class="p">)</span>
 <span class="o">-</span> <span class="n">latency</span> <span class="n">average</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">851</span> <span class="n">ms</span>
 <span class="o">-</span> <span class="n">latency</span> <span class="n">stddev</span> <span class="o">=</span> <span class="mi">0</span><span class="p">.</span><span class="mi">613</span> <span class="n">ms</span>
</pre></div>


<p>We are Initiating the failover from the console after 600 seconds and resuming the same workload once the failover is completed. For initiating the failover please go the 
After failover benchmarking</p>
<p>We are Initiating the failover from the console after 600 seconds and running the same workload once the failover is completed. For initiating the failover please go the RDS console, select your cluster and click on the writer instance and go the actions and click “Failover”.
<span class="image"><img alt="1-ccm-guide-34" src="1-ccm-guide-34.png?raw=true" /></span><br>
<span class="image"><img alt="1-ccm-guide-35" src="1-ccm-guide-35.png?raw=true" /></span><br></p>
<p>Once the failover is completed after about ~30 seconds. Verify the previous reader instance becomes the new writer.</p>
<p><span class="image"><img alt="1-ccm-guide-36" src="1-ccm-guide-36.png?raw=true" /></span><br></p>
<p>We will be running the same benchmarking as we did before the failover and then we will compare the pgbench metrics before and after the failover.</p>
<div class="codehilite"><pre><span></span><span class="p">.</span><span class="o">/</span><span class="n">pgbench</span>  <span class="o">--</span><span class="n">progress</span><span class="o">-</span><span class="n">timestamp</span> <span class="o">-</span><span class="n">M</span> <span class="n">prepared</span> <span class="o">-</span><span class="n">n</span> <span class="o">-</span><span class="n">T</span> <span class="mi">600</span> <span class="o">-</span><span class="n">P</span> <span class="mi">5</span>  <span class="o">-</span><span class="n">c</span> <span class="mi">50</span> <span class="o">-</span><span class="n">j</span> <span class="mi">50</span>  <span class="o">--</span><span class="n">host</span><span class="o">=</span><span class="n">labstack</span><span class="o">-</span><span class="n">cluster</span><span class="p">.</span><span class="n">cluster</span><span class="o">-</span><span class="n">xxxxxxxxx</span><span class="p">.</span><span class="n">us</span><span class="o">-</span><span class="n">west</span><span class="o">-</span><span class="mf">2.</span><span class="n">rds</span><span class="p">.</span><span class="n">amazonaws</span><span class="p">.</span><span class="n">com</span> <span class="o">-</span><span class="n">b</span> <span class="n">tpcb</span><span class="o">-</span><span class="n">like</span><span class="mi">@1</span> <span class="o">-</span><span class="n">b</span> <span class="n">select</span><span class="o">-</span><span class="n">only</span><span class="mi">@20</span> <span class="o">--</span><span class="n">username</span><span class="o">=</span><span class="n">masteruser</span> <span class="n">mylab</span><span class="o">&gt;</span> <span class="n">ccm_enable_after_failover</span><span class="p">.</span><span class="k">out</span>
</pre></div>


<p>After 600 seconds once, the benchmark is completed you can verify the pgbench output on the screen (on the psql console) or can refer the output file “ccm_enable_after_failover.out”. The summary output at the bottom will look like below. Please note that the output may be little bit different in your case.</p>
<div class="codehilite"><pre><span></span><span class="n">transaction</span> <span class="k">type</span><span class="p">:</span> <span class="n">multiple</span> <span class="n">scripts</span>
<span class="n">scaling</span> <span class="n">factor</span><span class="p">:</span> <span class="mi">10000</span>
<span class="n">query</span> <span class="k">mode</span><span class="p">:</span> <span class="n">prepared</span>
<span class="nb">number</span> <span class="k">of</span> <span class="n">clients</span><span class="p">:</span> <span class="mi">500</span>
<span class="nb">number</span> <span class="k">of</span> <span class="n">threads</span><span class="p">:</span> <span class="mi">500</span>
<span class="n">duration</span><span class="p">:</span> <span class="mi">600</span> <span class="n">s</span>
<span class="nb">number</span> <span class="k">of</span> <span class="n">transactions</span> <span class="n">actually</span> <span class="n">processed</span><span class="p">:</span> <span class="mi">85237916</span>
<span class="n">latency</span> <span class="n">average</span> <span class="o">=</span> <span class="mi">3</span><span class="p">.</span><span class="mi">518</span> <span class="n">ms</span>
<span class="n">latency</span> <span class="n">stddev</span> <span class="o">=</span> <span class="mi">7</span><span class="p">.</span><span class="mi">063</span> <span class="n">ms</span>
<span class="n">tps</span> <span class="o">=</span> <span class="mi">142047</span><span class="p">.</span><span class="mi">852230</span> <span class="p">(</span><span class="k">including</span> <span class="n">connections</span> <span class="n">establishing</span><span class="p">)</span>
<span class="n">tps</span> <span class="o">=</span> <span class="mi">142129</span><span class="p">.</span><span class="mi">718565</span> <span class="p">(</span><span class="k">excluding</span> <span class="n">connections</span> <span class="n">establishing</span><span class="p">)</span>
<span class="k">SQL</span> <span class="n">script</span> <span class="mi">1</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">builtin</span><span class="p">:</span> <span class="n">TPC</span><span class="o">-</span><span class="n">B</span> <span class="p">(</span><span class="n">sort</span> <span class="k">of</span><span class="p">)</span><span class="o">&gt;</span>
 <span class="o">-</span> <span class="n">weight</span><span class="p">:</span> <span class="mi">1</span> <span class="p">(</span><span class="n">targets</span> <span class="mi">4</span><span class="p">.</span><span class="mi">8</span><span class="o">%</span> <span class="k">of</span> <span class="n">total</span><span class="p">)</span>
 <span class="o">-</span> <span class="mi">4048031</span> <span class="n">transactions</span> <span class="p">(</span><span class="mi">4</span><span class="p">.</span><span class="mi">7</span><span class="o">%</span> <span class="k">of</span> <span class="n">total</span><span class="p">,</span> <span class="n">tps</span> <span class="o">=</span> <span class="mi">6745</span><span class="p">.</span><span class="mi">989769</span><span class="p">)</span>
 <span class="o">-</span> <span class="n">latency</span> <span class="n">average</span> <span class="o">=</span> <span class="mi">19</span><span class="p">.</span><span class="mi">971</span> <span class="n">ms</span>
 <span class="o">-</span> <span class="n">latency</span> <span class="n">stddev</span> <span class="o">=</span> <span class="mi">9</span><span class="p">.</span><span class="mi">161</span> <span class="n">ms</span>
<span class="k">SQL</span> <span class="n">script</span> <span class="mi">2</span><span class="p">:</span> <span class="o">&lt;</span><span class="n">builtin</span><span class="p">:</span> <span class="k">select</span> <span class="k">only</span><span class="o">&gt;</span>
 <span class="o">-</span> <span class="n">weight</span><span class="p">:</span> <span class="mi">20</span> <span class="p">(</span><span class="n">targets</span> <span class="mi">95</span><span class="p">.</span><span class="mi">2</span><span class="o">%</span> <span class="k">of</span> <span class="n">total</span><span class="p">)</span>
 <span class="o">-</span> <span class="mi">80121228</span> <span class="n">transactions</span> <span class="p">(</span><span class="mi">94</span><span class="p">.</span><span class="mi">0</span><span class="o">%</span> <span class="k">of</span> <span class="n">total</span><span class="p">,</span> <span class="n">tps</span> <span class="o">=</span> <span class="mi">133520</span><span class="p">.</span><span class="mi">959797</span><span class="p">)</span>
 <span class="o">-</span> <span class="n">latency</span> <span class="n">average</span> <span class="o">=</span> <span class="mi">2</span><span class="p">.</span><span class="mi">728</span> <span class="n">ms</span>
 <span class="o">-</span> <span class="n">latency</span> <span class="n">stddev</span> <span class="o">=</span> <span class="mi">5</span><span class="p">.</span><span class="mi">870</span> <span class="n">ms</span>
</pre></div>


<h3 id="46-ccm-vs-no-ccm-benchmarking-results-for-illustration-only">4.6. CCM vs no CCM benchmarking results (for illustration only)<a class="headerlink" href="#46-ccm-vs-no-ccm-benchmarking-results-for-illustration-only" title="Permanent link">&para;</a></h3>
<p>This benchmarking and the graph are only for illustrative purpose, this benchmarking is done on the r4.16xl instance size and with scale factor 10000 for data load.
This workshop creates Aurora PostgreSQL Database on R5.16xlarge instance class and data is loaded using and scale factor 100 so you are expected to get different results.</p>
<p>In the graph below, we are comparing the results from the benchmarking done on the CCM enabled and CCM disabled Aurora PostgreSQL clusters. The CCM enabled cluster was able to scale up to the average 90th Percentile of the Transaction per Second (TPS), whereas the CCM disabled cluster took about 357 seconds (990-633) to scale up to the 90th Percentile of the Transaction per Second</p>
<p><span class="image"><img alt="1-ccm-guide-37" src="1-ccm-guide-37.png?raw=true" /></span><br></p>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../qpm/" title="Query Plan Management" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Query Plan Management
              </span>
            </div>
          </a>
        
        
          <a href="../migration/" title="Oracle to Aurora PostgreSQL migration using DMS and SCT" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Oracle to Aurora PostgreSQL migration using DMS and SCT
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            &copy; 2019, Amazon Web Services, Inc. or its affiliates. All rights reserved.
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../../assets/fonts/font-awesome.css">
    
      <a href="https://mylabs.data-builder.com/" class="md-footer-social__link fa fa-home"></a>
    
      <a href="https://aws.amazon.com/rds/aurora/postgresql-features/" class="md-footer-social__link fa fa-amazon"></a>
    
      <a href="https://mylabs.data-builder.com/" class="md-footer-social__link fa fa-github"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.245445c6.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
    
  </body>
</html>