



<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      <meta http-equiv="x-ua-compatible" content="ie=edge">
      
        <meta name="description" content="Workshop and lab content for Amazon Aurora PostgreSQL compatible databases. This code will contain a series of templates, instructional guides and sample code to educate users on how to use Amazon Aurora features.">
      
      
        <link rel="canonical" href="https://mylabs.data-builder.com/modules/qpm/">
      
      
        <meta name="author" content="amazon-aurora-labs-for-mysql@amazon.com">
      
      
        <meta name="lang:clipboard.copy" content="Copy to clipboard">
      
        <meta name="lang:clipboard.copied" content="Copied to clipboard">
      
        <meta name="lang:search.language" content="en">
      
        <meta name="lang:search.pipeline.stopwords" content="True">
      
        <meta name="lang:search.pipeline.trimmer" content="True">
      
        <meta name="lang:search.result.none" content="No matching documents">
      
        <meta name="lang:search.result.one" content="1 matching document">
      
        <meta name="lang:search.result.other" content="# matching documents">
      
        <meta name="lang:search.tokenizer" content="[\s\-]+">
      
      <link rel="shortcut icon" href="../../assets/images/aws-favicon.ico">
      <meta name="generator" content="mkdocs-1.0.4, mkdocs-material-4.5.1">
    
    
      
        <title>Query Plan Management - Amazon Aurora Labs for PostgreSQL</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/application.1b62728e.css">
      
      
    
    
      <script src="../../assets/javascripts/modernizr.268332fc.js"></script>
    
    
      
        <link href="https://fonts.gstatic.com" rel="preconnect" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700|Roboto+Mono&display=fallback">
        <style>body,input{font-family:"Roboto","Helvetica Neue",Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono","Courier New",Courier,monospace}</style>
      
    
    <link rel="stylesheet" href="../../assets/fonts/material-icons.css">
    
    
      <link rel="stylesheet" href="../../assets/css/custom.css">
    
    
      
    
    
  </head>
  
    <body dir="ltr">
  
    <svg class="md-svg">
      <defs>
        
        
      </defs>
    </svg>
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" data-md-component="overlay" for="__drawer"></label>
    
      <a href="#query-plan-management" tabindex="1" class="md-skip">
        Skip to content
      </a>
    
    
      <!--
  Copyright (c) 2016-2018 Martin Donath <martin.donath@squidfunk.com>
  Permission is hereby granted, free of charge, to any person obtaining a copy
  of this software and associated documentation files (the "Software"), to
  deal in the Software without restriction, including without limitation the
  rights to use, copy, modify, merge, publish, distribute, sublicense, and/or
  sell copies of the Software, and to permit persons to whom the Software is
  furnished to do so, subject to the following conditions:
  The above copyright notice and this permission notice shall be included in
  all copies or substantial portions of the Software.
  THE SOFTWARE IS PROVIDED "AS IS", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR
  IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,
  FITNESS FOR A PARTICULAR PURPOSE AND NON-INFRINGEMENT. IN NO EVENT SHALL THE
  AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER
  LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING
  FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS
  IN THE SOFTWARE.
-->

<!-- Application header -->
<header class="md-header" data-md-component="header">

    <!-- Top-level navigation -->
    <nav class="md-header-nav md-grid">
      <div class="md-flex">

        <!-- Link to home -->
        <div class="md-flex__cell md-flex__cell--shrink">
          <a href="https://aws.amazon.com/"
              title="Amazon Web Services"
              class="md-header-nav__button md-logo">
            
              <img src="../../assets/images/aws_smile_logo.png" width="40" height="24" />
            
          </a>
        </div>

        <!-- Button to toggle drawer -->
        <div class="md-flex__cell md-flex__cell--shrink">
          <label class="md-icon md-icon--menu md-header-nav__button"
              for="__drawer"></label>
        </div>

        <!-- Header title -->
        <div class="md-flex__cell md-flex__cell--stretch">
          <div class="md-flex__ellipsis md-header-nav__title"
              data-md-component="title">
            
              
                <span class="md-header-nav__topic">
                  Amazon Aurora Labs for PostgreSQL
                </span>
                <span class="md-header-nav__topic">
                  Query Plan Management
                </span>
              
            
          </div>
        </div>

        <!-- Button to open search dialogue -->
        <div class="md-flex__cell md-flex__cell--shrink">
          
            
              <label class="md-icon md-icon--search md-header-nav__button"
                  for="__search"></label>

              <!-- Search interface -->
              
<div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="query" data-md-state="active">
      <label class="md-icon md-search__icon" for="__search"></label>
      <button type="reset" class="md-icon md-search__icon" data-md-component="reset" tabindex="-1">
        &#xE5CD;
      </button>
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" data-md-scrollfix>
        <div class="md-search-result" data-md-component="result">
          <div class="md-search-result__meta">
            Type to start searching
          </div>
          <ol class="md-search-result__list"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
            
          
        </div>

        <!-- Repository containing source -->
        
      </div>
    </nav>
  </header>
    
    <div class="md-container">
      
        
      
      
        

  

<nav class="md-tabs md-tabs--active" data-md-component="tabs">
  <div class="md-tabs__inner md-grid">
    <ul class="md-tabs__list">
      
        
  <li class="md-tabs__item">
    
      <a href="../.." class="md-tabs__link">
        Home
      </a>
    
  </li>

      
        
  <li class="md-tabs__item">
    
      <a href="../" class="md-tabs__link">
        Getting Started
      </a>
    
  </li>

      
        
  
  
    <li class="md-tabs__item">
      
        <a href="../prerequisites/" class="md-tabs__link md-tabs__link--active">
          Modules
        </a>
      
    </li>
  

      
    </ul>
  </div>
</nav>
      
      <main class="md-main" role="main">
        <div class="md-main__inner md-grid" data-md-component="container">
          
            
              <div class="md-sidebar md-sidebar--primary" data-md-component="navigation">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    <nav class="md-nav md-nav--primary" data-md-level="0">
  <label class="md-nav__title md-nav__title--site" for="__drawer">
    <a href="https://mylabs.data-builder.com/" title="Amazon Aurora Labs for PostgreSQL" class="md-nav__button md-logo">
      
        <img src="../../assets/images/aws_smile_logo.png" width="48" height="48">
      
    </a>
    Amazon Aurora Labs for PostgreSQL
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
      


  <li class="md-nav__item">
    <a href="../.." title="Home" class="md-nav__link">
      Home
    </a>
  </li>

    
      
      
      


  <li class="md-nav__item">
    <a href="../" title="Getting Started" class="md-nav__link">
      Getting Started
    </a>
  </li>

    
      
      
      

  


  <li class="md-nav__item md-nav__item--active md-nav__item--nested">
    
      <input class="md-toggle md-nav__toggle" data-md-toggle="nav-3" type="checkbox" id="nav-3" checked>
    
    <label class="md-nav__link" for="nav-3">
      Modules
    </label>
    <nav class="md-nav" data-md-component="collapsible" data-md-level="1">
      <label class="md-nav__title" for="nav-3">
        Modules
      </label>
      <ul class="md-nav__list" data-md-scrollfix>
        
        
          
          
          


  <li class="md-nav__item">
    <a href="../prerequisites/" title="Prerequisites" class="md-nav__link">
      Prerequisites
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../create/" title="Creating a New Aurora Cluster" class="md-nav__link">
      Creating a New Aurora Cluster
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../fastclone/" title="Fast Cloning" class="md-nav__link">
      Fast Cloning
    </a>
  </li>

        
          
          
          

  


  <li class="md-nav__item md-nav__item--active">
    
    <input class="md-toggle md-nav__toggle" data-md-toggle="toc" type="checkbox" id="__toc">
    
      
    
    
      <label class="md-nav__link md-nav__link--active" for="__toc">
        Query Plan Management
      </label>
    
    <a href="./" title="Query Plan Management" class="md-nav__link md-nav__link--active">
      Query Plan Management
    </a>
    
      
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-prerequisite" class="md-nav__link">
    1. Prerequisite
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-creating-aurora-postgresql-cluster-with-cloudformation" class="md-nav__link">
    2. Creating Aurora PostgreSQL cluster with Cloudformation
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-retrieving-database-credentials-from-secret-manager" class="md-nav__link">
    2.1 Retrieving Database credentials from Secret Manager
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-cloudformation-resource-chart" class="md-nav__link">
    2.2 Cloudformation Resource chart
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-connecting-to-the-ec2-bastion-instance-with-systems-manager" class="md-nav__link">
    2.3 Connecting to the EC2 bastion Instance with Systems Manager
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#24-connecting-to-the-ec2-bastion-instance" class="md-nav__link">
    2.4 Connecting to the EC2 bastion Instance
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-quick-start-guide-on-using-qpm-with-automatic-capture" class="md-nav__link">
    3. Quick start guide on using QPM with automatic capture
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-modify-the-amazon-aurora-db-cluster-parameters-related-to-the-ccm" class="md-nav__link">
    1. Modify the Amazon Aurora DB Cluster Parameters related to the CCM.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-create-and-verify-the-apg_plan_mgmt-extension-for-your-db-instance" class="md-nav__link">
    2. Create and verify the apg_plan_mgmt extension for your DB instance.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-run-synthetic-workload-with-automatic-capture" class="md-nav__link">
    3. Run synthetic workload with automatic capture.
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-qpm-plan-adaptability-with-plan-evolution-mechanism" class="md-nav__link">
    4. QPM Plan adaptability with plan evolution mechanism
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-fixing-plans-with-qpm-using-pg_hint_plan" class="md-nav__link">
    5. Fixing plans with QPM using pg_hint_plan
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-deploying-qpm-managed-plans-globally-using-export-and-import-no-lab" class="md-nav__link">
    6. Deploying QPM-managed plans globally using export and import (no lab)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-disabling-qpm-and-deleting-plans-manually" class="md-nav__link">
    7. Disabling QPM and deleting plans manually
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
    
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../ccm/" title="Cluster Cache Management" class="md-nav__link">
      Cluster Cache Management
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../migration/" title="Oracle to Aurora PostgreSQL migration using DMS and SCT" class="md-nav__link">
      Oracle to Aurora PostgreSQL migration using DMS and SCT
    </a>
  </li>

        
          
          
          


  <li class="md-nav__item">
    <a href="../das/" title="Database Activity Streaming" class="md-nav__link">
      Database Activity Streaming
    </a>
  </li>

        
      </ul>
    </nav>
  </li>

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              <div class="md-sidebar md-sidebar--secondary" data-md-component="toc">
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    
<nav class="md-nav md-nav--secondary">
  
  
    
  
  
    <label class="md-nav__title" for="__toc">Table of contents</label>
    <ul class="md-nav__list" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#1-prerequisite" class="md-nav__link">
    1. Prerequisite
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#2-creating-aurora-postgresql-cluster-with-cloudformation" class="md-nav__link">
    2. Creating Aurora PostgreSQL cluster with Cloudformation
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#21-retrieving-database-credentials-from-secret-manager" class="md-nav__link">
    2.1 Retrieving Database credentials from Secret Manager
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#22-cloudformation-resource-chart" class="md-nav__link">
    2.2 Cloudformation Resource chart
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#23-connecting-to-the-ec2-bastion-instance-with-systems-manager" class="md-nav__link">
    2.3 Connecting to the EC2 bastion Instance with Systems Manager
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#24-connecting-to-the-ec2-bastion-instance" class="md-nav__link">
    2.4 Connecting to the EC2 bastion Instance
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#3-quick-start-guide-on-using-qpm-with-automatic-capture" class="md-nav__link">
    3. Quick start guide on using QPM with automatic capture
  </a>
  
    <nav class="md-nav">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#1-modify-the-amazon-aurora-db-cluster-parameters-related-to-the-ccm" class="md-nav__link">
    1. Modify the Amazon Aurora DB Cluster Parameters related to the CCM.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#2-create-and-verify-the-apg_plan_mgmt-extension-for-your-db-instance" class="md-nav__link">
    2. Create and verify the apg_plan_mgmt extension for your DB instance.
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#3-run-synthetic-workload-with-automatic-capture" class="md-nav__link">
    3. Run synthetic workload with automatic capture.
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#4-qpm-plan-adaptability-with-plan-evolution-mechanism" class="md-nav__link">
    4. QPM Plan adaptability with plan evolution mechanism
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#5-fixing-plans-with-qpm-using-pg_hint_plan" class="md-nav__link">
    5. Fixing plans with QPM using pg_hint_plan
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#6-deploying-qpm-managed-plans-globally-using-export-and-import-no-lab" class="md-nav__link">
    6. Deploying QPM-managed plans globally using export and import (no lab)
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#7-disabling-qpm-and-deleting-plans-manually" class="md-nav__link">
    7. Disabling QPM and deleting plans manually
  </a>
  
</li>
      
      
      
      
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          <div class="md-content">
            <article class="md-content__inner md-typeset">
              
                
                
                <h1 id="query-plan-management">Query Plan Management<a class="headerlink" href="#query-plan-management" title="Permanent link">&para;</a></h1>
<h2 id="1-prerequisite">1. Prerequisite<a class="headerlink" href="#1-prerequisite" title="Permanent link">&para;</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>If you started with module - "Creating a New Aurora Cluster" please skip to the next step/section as you have already created the EC2 key pair which  you can use for this lab.</p>
</div>
<p><strong>Create an EC2 Key Pair</strong>: <br> </p>
<p>You will need an EC2 key pair in order to log into the EC2 bastion instance<br></p>
<p>To create a new key pair: </p>
<ol>
<li>Open the EC2 service console</li>
<li>In the left-hand gutter under “Network &amp; Security” click “Key Pairs”</li>
<li>Supply a name and click “Create”</li>
<li>Download or otherwise save the .pem file</li>
</ol>
<h2 id="2-creating-aurora-postgresql-cluster-with-cloudformation">2. Creating Aurora PostgreSQL cluster with Cloudformation<a class="headerlink" href="#2-creating-aurora-postgresql-cluster-with-cloudformation" title="Permanent link">&para;</a></h2>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>if you started the lab with module "Creating a New Aurora Cluster" please skip the section -2 and proceed to the next section as you have already created the Aurora PostgreSQL cluster.</p>
</div>
<ol>
<li><a href="https://us-west-2.console.aws.amazon.com/cloudformation/home?region=us-west-2" target="_blank">Log in to your AWS console and go to the CloudFormation landing page</a></li>
<li>Click create stack, select ‘Specify an Amazon S3 template URL’ and launch the CloudFormation stack from this <a href="https://tinyurl.com/my-cf-template" target="_blank">template</a></li>
<li>Download and save this locally and use upload a template to S3 option and click on “Choose File” option to point to the location where you have saved the template.</li>
<li>Here is a screenshot of the first page – 
<span class="image"><img alt="1-qpm-cf1" src="1-qpm-cf1.png?raw=true" /></span>
<br>
<span class="image"><img alt="1-qpm-cf-2" src="1-qpm-cf-2.png?raw=true" /></span><br>
<span class="image"><img alt="1-qpm-cf-3" src="1-qpm-cf-3.png?raw=true" /></span><br>
<span class="image"><img alt="1-qpm-cf-4" src="1-qpm-cf-4.png?raw=true" /></span><br>
<span class="image"><img alt="1-qpm-cf-5" src="1-qpm-cf-5.png?raw=true" /></span><br>
<span class="image"><img alt="1-qpm-cf-6" src="1-qpm-cf-6.png?raw=true" /></span><br>
<span class="image"><img alt="1-qpm-cf-7" src="1-qpm-cf-7.png?raw=true" /></span><br>
<span class="image"><img alt="1-qpm-cf-8" src="1-qpm-cf-8.png?raw=true" /></span><br>
<span class="image"><img alt="1-qpm-cf-9" src="1-qpm-cf-9.png?raw=true" /></span><br>
<span class="image"><img alt="1-qpm-cf-10" src="1-qpm-cf-10.png?raw=true" /></span><br>
<span class="image"><img alt="1-qpm-cf-11" src="1-qpm-cf-11.png?raw=true" /></span><br></li>
</ol>
<h3 id="21-retrieving-database-credentials-from-secret-manager">2.1 Retrieving Database credentials from Secret Manager<a class="headerlink" href="#21-retrieving-database-credentials-from-secret-manager" title="Permanent link">&para;</a></h3>
<ol>
<li>
<p>Search for the secret name as shown in the output of the stack and select the secret name.
<span class="image"><img alt="1-qpm-secrets-1" src="1-qpm-secrets-1.png?raw=true" /></span><br> </p>
</li>
<li>
<p>Click on the Retrieve secret value to get the Database user and the password to connect to the Aurora Database.
<span class="image"><img alt="1-qpm-secrets-2" src="1-qpm-secrets-2.png?raw=true" /></span><br>
<span class="image"><img alt="1-qpm-secrets-3" src="1-qpm-secrets-3.png?raw=true" /></span><br>
<span class="image"><img alt="1-qpm-secrets-4" src="1-qpm-secrets-4.png?raw=true" /></span><br></p>
</li>
</ol>
<h3 id="22-cloudformation-resource-chart">2.2 Cloudformation Resource chart<a class="headerlink" href="#22-cloudformation-resource-chart" title="Permanent link">&para;</a></h3>
<p>Please note that the Database names and the Custom Cluster and Database Parameter groups shown below are only for illustrative purpose. Participants are required to use the appropriate resources created from the Cloudformation template.</p>
<p><strong>Please refer the below table for the list of resources and the value</strong></p>
<table>
<thead>
<tr>
<th>Resource name</th>
<th>Value</th>
</tr>
</thead>
<tbody>
<tr>
<td>Cluster Parameter Group</td>
<td>refer CloudFormation template output section and refer the key value “apgcustomclusterparamgroup”</td>
</tr>
<tr>
<td>Database Parameter Group</td>
<td>refer CloudFormation template output section and refer the key value “apgcustomdbparamgroup”</td>
</tr>
<tr>
<td>Cluster Endpoint</td>
<td>refer CloudFormation template output section and refer the key value “clusterEndpoint”</td>
</tr>
<tr>
<td>Reader Endpoint</td>
<td>refer CloudFormation template output section and refer the key value “readerEndpoint”</td>
</tr>
<tr>
<td>DB name</td>
<td>mylab</td>
</tr>
<tr>
<td>DB username</td>
<td>masteruser</td>
</tr>
<tr>
<td>DB password</td>
<td>extract from the secrets Manager as shown above</td>
</tr>
<tr>
<td>bastionEndpoint</td>
<td>refer CloudFormation template output section and refer the key value “bastionEndpoint”</td>
</tr>
</tbody>
</table>
<h3 id="23-connecting-to-the-ec2-bastion-instance-with-systems-manager">2.3 Connecting to the EC2 bastion Instance with Systems Manager<a class="headerlink" href="#23-connecting-to-the-ec2-bastion-instance-with-systems-manager" title="Permanent link">&para;</a></h3>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>We recommend using AWS Systems Manager to connect to the EC2 Instance as Session Manager provides secure and auditable instance management without the need to open inbound ports, maintain bastion hosts, or manage SSH keys. If you preferred to use EC2 Instance using SSH key access then proceed to section 2.4 instead</p>
</div>
<div class="admonition warning">
<p class="admonition-title">Region Check</p>
<p>Ensure you are still working in the correct region, especially if you are following the links above to open the service console at the right screen.</p>
</div>
<ol>
<li>Connect to your workstation instance</li>
</ol>
<p>Open the Systems Manager: Session Manager service console. Click <strong>Configure Preferences</strong>.</p>
<p>Ensure you are still working in the correct region, especially if you are following the links above to open the service console at the right screen.</p>
<p>On the AWS console search for Systems Manager and click on <strong>Systems Manager</strong> Service. Select the <strong>Session Manager</strong> on the left-hand side.</p>
<p><span class="image"><img alt="1-ssm1_1" src="../prerequisites/ssm1_1.png?raw=true" /></span><br></p>
<p><span class="image"><img alt="1-ssm1_2" src="../prerequisites/ssm1_2.png?raw=true" /></span><br></p>
<p>Click on the Start session </p>
<p><span class="image"><img alt="1-ssm1_3" src="../prerequisites/ssm1_3.png?raw=true" /></span><br></p>
<p>Click on <strong>Start session</strong></p>
<p>Select the Instance name which was created part of the Cloudformation template, the name of the Instance has the naming convention <Stack name-bastion-host> </p>
<p><span class="image"><img alt="1-ssm1_4" src="../prerequisites/ssm1_4.png?raw=true" /></span><br></p>
<p>Click on <strong>Start session</strong> again to go the EC2 instance screen.</p>
<p>By default the system manager connects as <strong>ssmuser</strong> . All the lab work has been performed as <strong>ec2-user</strong> . We need to switch to the <strong>ec2-user</strong> </p>
<div class="codehilite"><pre><span></span>sh-4.2$ whoami
ssm-user
sh-4.2$ sudo su -
Last login: Thu Feb 27 02:28:24 UTC 2020 on pts/1
[root@ip-x.x.x.x ~]# su - ec2-user
Last login: Wed Feb 26 18:04:46 UTC 2020 on pts/0
[ec2-user@x.x.x.x ~]$ whoami
ec2-user
</pre></div>


<p><span class="image"><img alt="1-ssm1_5" src="../prerequisites/ssm1_5.png?raw=true" /></span><br></p>
<h3 id="24-connecting-to-the-ec2-bastion-instance">2.4 Connecting to the EC2 bastion Instance<a class="headerlink" href="#24-connecting-to-the-ec2-bastion-instance" title="Permanent link">&para;</a></h3>
<p>We are creating EC2 instance (Amazon Linux AMI-ID ami-0f2176987ee50226e) and bootstrapping the EC2 Instance to have pgbench and sysbench benchmarking tools to be installed.</p>
<div class="codehilite"><pre><span></span>ssh -i &lt;keypair.pem&gt; ec2-user@&lt;bastionEndpoint&gt;
</pre></div>


<p>Replace the [<code>keypair.pem</code>] with the keypair file name input provided to the Cloud formation template. Replace the “bastionEndpoint” with the key value from the output section of the Cloud formation template.</p>
<p>If you need to open an access for your laptop IP specifically, then whitelist your IP, by specifying your IP in the format <code>x.x.x.x/32</code> (<a href=" http://www.whatsmyip.org/" target="_blank">Lookup your IP </a>). If there are any issues in accessing the instance, you can always modify the security group to populate your IP address as My IP as mentioned <a href="https://docs.aws.amazon.com/AWSEC2/latest/UserGuide/authorizing-access-to-an-instance.html" target="_blank"> here</a>. </p>
<h2 id="3-quick-start-guide-on-using-qpm-with-automatic-capture">3. Quick start guide on using QPM with automatic capture<a class="headerlink" href="#3-quick-start-guide-on-using-qpm-with-automatic-capture" title="Permanent link">&para;</a></h2>
<p>Query plan management is available with Amazon Aurora PostgreSQL version 10.5-compatible (Aurora 2.1.0) and later, or Amazon Aurora PostgreSQL version 9.6.11-compatible (Aurora 1.4.0) and later. The quickest way to enable QPM is to use the automatic plan capture, which enables the plan capture for all SQL statements that run at least two times. </p>
<p>With query plan management, you can control execution plans for a set of statements that you want to manage. You can do the following: </p>
<ol>
<li>Improve plan stability by forcing the optimizer to choose from a small number of known, good plans. </li>
<li>Optimize plans centrally and then distribute the best plans globally.</li>
<li>Identify indexes that aren't used and assess the impact of creating or dropping an index. </li>
<li>Automatically detect a new minimum-cost plan discovered by the optimizer.</li>
<li>Try new optimizer features with less risk, because you can choose to approve only the plan changes that improve performance. </li>
</ol>
<p>For additional details on the Query Plan Management please refer official documentation <a href="https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/AuroraPostgreSQL.Optimize.html" target="_blank"> Managing Query Execution Plans for Aurora PostgreSQL</a>.</p>
<p><strong>Here are the steps to configure and enable the use of QPM on your Aurora PostgreSQL cluster for automatic capture and using managed plans with QPM: </strong></p>
<h3 id="1-modify-the-amazon-aurora-db-cluster-parameters-related-to-the-ccm">1. Modify the Amazon Aurora DB Cluster Parameters related to the CCM.<a class="headerlink" href="#1-modify-the-amazon-aurora-db-cluster-parameters-related-to-the-ccm" title="Permanent link">&para;</a></h3>
<p>Screenshots of some of the steps are shown below<br>
a. Open the <a href="https://us-west-2.console.aws.amazon.com/rds/home?region=us-west-2" target="_blank">Amazon RDS service console</a>.<br>
b. In the navigation pane, choose Parameter groups.
<span class="image"><img alt="1-qpm-guide-1" src="1-qpm-guide-1.png?raw=true" /></span><br>
c. In the list, choose the parameter group for your Aurora PostgreSQL DB cluster.  Please refer the name of the DB cluster parameter group file created from the output section of the CloudFormation Stack. It is in the format <code>&lt;stack-name-apgcustom-clusterparamgroup-nnnn&gt;</code>. In this case the stack name is <code>labstack</code> and hence the DB cluster parameter group file is <code>labstack- apgcustom-clusterparamgroup-nnnn</code>. The DB cluster must use a parameter group other than the default, because you can't change values in a default parameter group.
For more information , <a href="https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/USER_WorkingWithParamGroups.html#USER_WorkingWithParamGroups.CreatingCluster" target="_blank"> see Creating a DB Cluster Parameter Group. </a>
<span class="image"><img alt="1-qpm-guide-2" src="1-qpm-guide-2.png?raw=true" /></span><br>
d. Click on the DB cluster parameter group selected above and then click on “Edit Parameters” 
<span class="image"><img alt="1-qpm-guide-3" src="1-qpm-guide-3.png?raw=true" /></span><br>
e. Set the value of rds.enable_plan_management parameter to 1 and click on “Save changes” 
<span class="image"><img alt="1-qpm-guide-4" src="1-qpm-guide-4.png?raw=true" /></span><br>
f. Open your database level parameter group and click on “Edit Parameters” 
<span class="image"><img alt="1-qpm-guide-5" src="1-qpm-guide-5.png?raw=true" /></span><br>
<span class="image"><img alt="1-qpm-guide-6" src="1-qpm-guide-6.png?raw=true" /></span><br>
g. Modify the value for apg_plan_mgmt.capture_plan_baselines parameter to “automatic” and apg_plan_mgmt.use_plan_baselines to “automatic”. Modify the value for apg_plan_mgmt.use_plan_baselines to “true”. For more information, see Modifying Parameters in a DB Parameter Group. Please note that these parameters can be set at either the cluster level or at the database level. The default recommendation would be to set it at the Aurora cluster level.
<span class="image"><img alt="1-qpm-guide-7" src="1-qpm-guide-7.png?raw=true" /></span><br>
<span class="image"><img alt="1-qpm-guide-8" src="1-qpm-guide-8.png?raw=true" /></span><br>
h. Click on the “Preview changes” to verify the changes and click save changes.
<span class="image"><img alt="1-qpm-guide-9" src="1-qpm-guide-9.png?raw=true" /></span><br>
<span class="image"><img alt="1-qpm-guide-10" src="1-qpm-guide-10.png?raw=true" /></span><br>
i. Wait for the status of the instance to change to <code>available</code>. Restart your DB instance to enable this new setting.
j. Connect to your DB instance with a SQL client such as psql. For more information,<a href="https://docs.aws.amazon.com/AmazonRDS/latest/UserGuide/USER_ConnectToPostgreSQLInstance.html#USER_ConnectToPostgreSQLInstance.psql" target="_blank"> see Using psql to Connect to a PostgreSQL DB Instance </a>. </p>
<p><br> The cluster endpoint for the Aurora PostgreSQL can be found from the key value from the output’s sections under “clusterEndpoint” key. <br> The username and the password need to be extracted from the secrets Manager as shown above</p>
<div class="codehilite"><pre><span></span>./psql -h &lt;cluster-endpoint&gt; -p &lt;port&gt;- U &lt;username&gt; -d &lt;dbname&gt;

cd /home/ec2-user/postgresql-10.7/src/bin/psql

export PATH=/home/ec2-user/postgresql-10.7/src/bin/:$PATH

./psql -h  labstack-cluster.cluster-xxxxxxxxx.us-west-2.rds.amazonaws.com -p 5432 -U  masteruser -d mylab
mylab=&gt; select aurora_version(),version();
</pre></div>


<div class="codehilite"><pre><span></span> aurora_version |                                   version                                   
----------------+-----------------------------------------------------------------------------
 2.3.5          | PostgreSQL 10.7 on x86_64-pc-linux-gnu, compiled by gcc (GCC) 4.9.3, 64-bit
(1 row)
</pre></div>


<h3 id="2-create-and-verify-the-apg_plan_mgmt-extension-for-your-db-instance">2. Create and verify the apg_plan_mgmt extension for your DB instance.<a class="headerlink" href="#2-create-and-verify-the-apg_plan_mgmt-extension-for-your-db-instance" title="Permanent link">&para;</a></h3>
<p>a. Create the apg_plan_mgmt extension for your DB instance.</p>
<div class="codehilite"><pre><span></span>mylab=&gt; CREATE EXTENSION apg_plan_mgmt;
CREATE EXTENSION
</pre></div>


<div class="codehilite"><pre><span></span>mylab=&gt; select extname,extversion from pg_extension where extname=&#39;apg_plan_mgmt&#39;;
    extname    | extversion 
---------------+------------
 apg_plan_mgmt | 1.0.1
</pre></div>


<p>b. Query to make sure that all QPM-related parameters are modified to the appropriate value.</p>
<div class="codehilite"><pre><span></span>mylab=&gt; show rds.enable_plan_management;
 rds.enable_plan_management 
----------------------------
 1

mylab=&gt; show apg_plan_mgmt.capture_plan_baselines;
 apg_plan_mgmt.capture_plan_baselines 
--------------------------------------
 automatic

mylab=&gt; show apg_plan_mgmt.use_plan_baselines;
 apg_plan_mgmt.use_plan_baselines 
----------------------------------
 on
</pre></div>


<h3 id="3-run-synthetic-workload-with-automatic-capture">3. Run synthetic workload with automatic capture.<a class="headerlink" href="#3-run-synthetic-workload-with-automatic-capture" title="Permanent link">&para;</a></h3>
<p>The Cloud Formation template used for this workshop creates an EC2 bastion host bootstrapped with PostgreSQL tools (Pgbench, psql and sysbench etc.). The CF will also initialize the Database with pgbench (scale=100) data.
a. From another EC2 Instance terminal use pgbench (a PostgreSQL benchmarking tool) to generate a simulated workload, which runs same queries for a specified period. With automatic capture enabled, QPM captures plans for each query that runs at least twice. Below is the example.</p>
<div class="codehilite"><pre><span></span><span class="n">export</span> <span class="n">PATH</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">ec2</span><span class="o">-</span><span class="n">user</span><span class="o">/</span><span class="n">postgresql</span><span class="o">-</span><span class="mf">10.7</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="nl">pgbench</span><span class="p">:</span><span class="err">$</span><span class="n">PATH</span>

<span class="n">cd</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">ec2</span><span class="o">-</span><span class="n">user</span><span class="o">/</span><span class="n">postgresql</span><span class="o">-</span><span class="mf">10.7</span><span class="o">/</span><span class="n">src</span><span class="o">/</span><span class="n">bin</span><span class="o">/</span><span class="n">pgbench</span>

<span class="p">.</span><span class="o">/</span><span class="n">pgbench</span>  <span class="o">--</span><span class="n">progress</span><span class="o">-</span><span class="n">timestamp</span> <span class="o">-</span><span class="n">M</span> <span class="n">prepared</span> <span class="o">-</span><span class="n">n</span> <span class="o">-</span><span class="n">T</span> <span class="mi">100</span> <span class="o">-</span><span class="n">P</span> <span class="mi">1</span>  <span class="o">-</span><span class="n">c</span> <span class="mi">500</span> <span class="o">-</span><span class="n">j</span> <span class="mi">500</span>  <span class="o">--</span><span class="n">host</span><span class="o">=</span><span class="n">labstack</span><span class="o">-</span><span class="n">cluster</span><span class="p">.</span><span class="n">cluster</span><span class="o">-</span><span class="n">xxxxxxxxx</span><span class="p">.</span><span class="n">us</span><span class="o">-</span><span class="n">west</span><span class="o">-</span><span class="mf">2.</span><span class="n">rds</span><span class="p">.</span><span class="n">amazonaws</span><span class="p">.</span><span class="n">com</span> <span class="o">-</span><span class="n">b</span> <span class="n">tpcb</span><span class="o">-</span><span class="n">like</span><span class="mi">@1</span> <span class="o">-</span><span class="n">b</span> <span class="n">select</span><span class="o">-</span><span class="n">only</span><span class="mi">@20</span> <span class="o">--</span><span class="n">username</span><span class="o">=</span><span class="n">masteruser</span> <span class="n">mylab</span>
</pre></div>


<p>b. Query apg_plan_mgmt.dba_plans table to view the managed statements and the execution plans for the SQL statements started with the pgbench tool.</p>
<div class="codehilite"><pre><span></span>cd /home/ec2-user/postgresql-10.7/src/bin/psql

export PATH=/home/ec2-user/postgresql-10.7/src/bin/:$PATH

./psql -h  labstack-cluster.cluster-xxxxxxxxx.us-west-2.rds.amazonaws.com -p 5432 -U  masteruser -d mylab
</pre></div>


<div class="codehilite"><pre><span></span>mylab=&gt; SELECT sql_hash, 
       plan_hash, 
       status, 
       enabled, 
       sql_text 
FROM   apg_plan_mgmt.dba_plans;

  sql_hash   |  plan_hash  |   status   | enabled |                                               sql_text                                                
-1677381765 -225188843   Approved        t          UPDATE pgbench_branches SET bbalance = bbalance + $1 WHERE bid = $2;
-60114982   300482084    Approved        t           INSERT INTO pgbench_history (tid, bid, aid, delta, mtime) VALUES ($1, $2, $3, $4, CURRENT_TIMESTAMP);
1319555216  30042398     Approved        t          select count(*) from pgbench_branches;

-2033469270 -1987991358  Approved        t           UPDATE pgbench_tellers SET tbalance = tbalance + $1 WHERE tid = $2;
</pre></div>


<p>c. Turn off automatic capture.
Capturing all plans with automatic capture has little runtime overhead and can be enabled in production. We are turning off the automatic capture to make sure that we don’t capture SQL statements outside the pgbench workload. This can be turned off by setting the apg_plan_mgmt.capture_plan_baselines parameter to off from the DB instance-level parameter group.
<span class="image"><img alt="1-qpm-guide-11" src="1-qpm-guide-11.png?raw=true" /></span><br></p>
<div class="codehilite"><pre><span></span>mylab=&gt; show apg_plan_mgmt.capture_plan_baselines;
 apg_plan_mgmt.capture_plan_baselines 
--------------------------------------
 Off
</pre></div>


<p>d. Verify that the execution plan of the managed statement is the plan captured by QPM.</p>
<p>We have manually executed the explain plan on one of the managed statements (highlighted in the yellow above). The explain plan output does show the SQL hash and the plan hash matches with the QPM approved plan for that statement.</p>
<div class="codehilite"><pre><span></span>mylab=&gt; explain (hashes true)  
UPDATE pgbench_tellers
SET    tbalance = tbalance + 100
WHERE  tid = 200; 
                         QUERY PLAN                                             
----------------------------------------------------------------------
 Update on pgbench_tellers  (cost=0.14..8.16 rows=1 width=358)
   -&gt;  Index Scan using pgbench_tellers_pkey on pgbench_tellers  (cost=0.14..8.16 rows=1 width=358)
         Index Cond: (tid = 200)
 SQL Hash: -2033469270, Plan Hash: -1987991358
</pre></div>


<p>In addition to automatic plan capture, QPM also offers manual capture, which offers a mechanism to capture execution plans for known problematic queries. Capturing the plans automatically is recommended generally. However, there are situations where capturing plans manually would be the best option, such as:</p>
<ol>
<li>You don't want to enable plan management at the Database level, but you do want to control a few critical SQL statements only.</li>
<li>You want to save the plan for a specific set of literals or parameter values that are causing a performance problem.</li>
</ol>
<h2 id="4-qpm-plan-adaptability-with-plan-evolution-mechanism">4. QPM Plan adaptability with plan evolution mechanism<a class="headerlink" href="#4-qpm-plan-adaptability-with-plan-evolution-mechanism" title="Permanent link">&para;</a></h2>
<p>If the optimizer's generated plan is not a stored plan, the optimizer captures and stores it as a new unapproved plan to preserve stability for the QPM-managed SQL statements. </p>
<p>Query plan management provides techniques and functions to add, maintain, and improve execution plans and thus provides Plan adaptability. Users can on demand or periodically instruct QPM to evolve all the stored plans to see if there is a better minimum cost plan available than any of the approved plans. </p>
<p>QPM provides <strong><em>apg_plan_mgmt.evolve_plan_baselines</em></strong> function to compare plans based on their actual performance. Depending on the outcome of your performance experiments, you can change a plan's status from unapproved to either approved or rejected. You can instead decide to use the apg_plan_mgmt.evolve_plan_baselines function to temporarily disable a plan if it does not meet your requirements. </p>
<p>For additional details about the QPM Plan evolution, <a href="https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/AuroraPostgreSQL.Optimize.Maintenance.html#AuroraPostgreSQL.Optimize.Maintenance.EvaluatingPerformance" target="_blank"> see Evaluating Plan Performance. </a></p>
<p>For the first use case, we walk through an example on how QPM helps ensure plan stability, these changes can result in plan regression. </p>
<p>In most cases, you set up QPM to use automatic plan capture so that plans are captured for all statements that run two or more times. However, you can also capture plans for a specific set of statements that you specify manually. 
To do this, you set <code>apg_plan_mgmt.capture_plan_baselines = off</code> by default. At the session level, <code>apg_plan_mgmt.capture_plan_baselines = manual</code> at the session level. How to do it is described later.</p>
<p>a. Enable manual plan capture to instruct QPM to capture the execution plan of the desired SQL statements manually.</p>
<div class="codehilite"><pre><span></span>mylab=&gt; SET apg_plan_mgmt.capture_plan_baselines = manual;
SET
</pre></div>


<p>b. Run an explain plan for the query so that QPM can capture the plan of the query (the following output for the explain plan is truncated for brevity).</p>
<div class="codehilite"><pre><span></span>mylab=&gt; explain (hashes true) 
SELECT Sum(delta),
            Sum(bbalance)
FROM   pgbench_history h,
           pgbench_branches b
WHERE  b.bid = h.bid
       AND b.bid IN ( 1, 2, 3 )
       AND mtime BETWEEN (SELECT Min(mtime)
                          FROM   pgbench_history mn) AND (SELECT Max(mtime)
                                                          FROM  pgbench_history mx); 
                      QUERY PLAN                                                  
----------------------------------------------------------------------
 Aggregate  (cost=23228.13..23228.14 rows=1 width=16)
   InitPlan 1 (returns $1)
     -&gt;  Finalize Aggregate  (cost=6966.00..6966.01 rows=1 width=8)
           -&gt;  Gather  (cost=6965.89..6966.00 rows=1 width=8)
                 Workers Planned: 1
                 -&gt;  Partial Aggregate  (cost=5965.89..5965.90 rows=1 width=8)
                       -&gt;  Parallel Seq Scan on pgbench_history mn  (cost=0.00..5346.11 rows=247911 width=8)
   InitPlan 2 (returns $3)
     -&gt;  Finalize Aggregate  (cost=6966.00..6966.01 rows=1 width=8)
           -&gt;  Gather  (cost=6965.89..6966.00 rows=1 width=8)
                 Workers Planned: 1
                 -&gt;  Partial Aggregate  (cost=5965.89..5965.90 rows=1 width=8)
                       -&gt;  Parallel Seq Scan on pgbench_history mx  (cost=0.00..5346.11 rows=247911 width=8)
   -&gt;  Nested Loop  (cost=0.00..9292.95 rows=632 width=8)
         Join Filter: (h.bid = b.bid)
         -&gt;  Seq Scan on pgbench_history h  (cost=0.00..9188.74 rows=2107 width=8)
               Filter: ((mtime &gt;= $1) AND (mtime &lt;= $3))
         -&gt;  Materialize  (cost=0.00..14.15 rows=3 width=8)
               -&gt;  Seq Scan on pgbench_branches b  (cost=0.00..14.14 rows=3 width=8)
                     Filter: (bid = ANY (&#39;{1,2,3}&#39;::integer[]))
………………………………………………………………………..
SQL Hash: 1561242727, Plan Hash: -1990695905
</pre></div>


<p>c. Disable manual capture of the plan after you capture the execution plan for the desired SQL statement.</p>
<div class="codehilite"><pre><span></span>mylab=&gt; SET apg_plan_mgmt.capture_plan_baselines = off;
SET
</pre></div>


<p>d. View the captured query plan for the query that ran previously. The plan_outline column in the table apg_plan_mgmt.dba_plans shows the entire plan for the SQL. For brevity, the plan_outline isn't shown here. Instead, plan_hash_value from the explain plan preceding is compared with plan_hash from the output of the apg_plan_mgmt.dba_plans query.</p>
<div class="codehilite"><pre><span></span>mylab=&gt; SELECT sql_hash,
             plan_hash,
            status,
            estimated_total_cost &quot;cost&quot;,
            sql_text
FROM apg_plan_mgmt.dba_plans;
  sql_hash          |  plan_hash        |  status   | cost  |  sql_text                                                                                                         

------------+-------------+----------+---------+-----------------------------------------------------------









1561242727  -1990695905  Approved    23228.14        select sum(delta),sum(bbalance) from pgbench_history h, pgbench_branches b where b.bid=h.bid and b.bid in (1,2,3) and mtime between (select min(mtime) from pgbench_history mn) and (select max(mtime) from pgbench_history mx); 
</pre></div>


<p>e. To instruct the query optimizer to use the approved or preferred captured plans for your managed statements, set the parameter apg_plan_mgmt.use_plan_baselines to true.</p>
<div class="codehilite"><pre><span></span>mylab=&gt; SET apg_plan_mgmt.use_plan_baselines = true;
SET
</pre></div>


<p>f. View the explain plan output to see that the QPM approved plan is used by the query optimizer.</p>
<div class="codehilite"><pre><span></span>mylab=&gt; explain (hashes true) 
SELECT Sum(delta),
            Sum(bbalance)
FROM   pgbench_history h,
           pgbench_branches b
WHERE  b.bid = h.bid
       AND b.bid IN ( 1, 2, 3 )
       AND mtime BETWEEN (SELECT Min(mtime)
                          FROM   pgbench_history mn) AND (SELECT Max(mtime)
                                                          FROM  pgbench_history mx); 

                      QUERY PLAN                                                  
----------------------------------------------------------------------
 Aggregate  (cost=23228.13..23228.14 rows=1 width=16)
   InitPlan 1 (returns $1)
     -&gt;  Finalize Aggregate  (cost=6966.00..6966.01 rows=1 width=8)
           -&gt;  Gather  (cost=6965.89..6966.00 rows=1 width=8)
                 Workers Planned: 1
                 -&gt;  Partial Aggregate  (cost=5965.89..5965.90 rows=1 width=8)
                       -&gt;  Parallel Seq Scan on pgbench_history mn  (cost=0.00..5346.11 rows=247911 width=8)
   InitPlan 2 (returns $3)
     -&gt;  Finalize Aggregate  (cost=6966.00..6966.01 rows=1 width=8)
           -&gt;  Gather  (cost=6965.89..6966.00 rows=1 width=8)
                 Workers Planned: 1
                 -&gt;  Partial Aggregate  (cost=5965.89..5965.90 rows=1 width=8)
                       -&gt;  Parallel Seq Scan on pgbench_history mx  (cost=0.00..5346.11 rows=247911 width=8)
   -&gt;  Nested Loop  (cost=0.00..9292.95 rows=632 width=8)
         Join Filter: (h.bid = b.bid)
         -&gt;  Seq Scan on pgbench_history h  (cost=0.00..9188.74 rows=2107 width=8)
               Filter: ((mtime &gt;= $1) AND (mtime &lt;= $3))
         -&gt;  Materialize  (cost=0.00..14.15 rows=3 width=8)
               -&gt;  Seq Scan on pgbench_branches b  (cost=0.00..14.14 rows=3 width=8)
                     Filter: (bid = ANY (&#39;{1,2,3}&#39;::integer[]))
………………………………………………………………………..
SQL Hash: 1561242727, Plan Hash: -1990695905
</pre></div>


<p>g. Create a new index on the pgbench_history table column “mtime” to change the planner configuration and force the query optimizer to generate a new plan.</p>
<div class="codehilite"><pre><span></span>mylab=&gt; create index pgbench_hist_mtime on pgbench_history(mtime);
CREATE INDEX
</pre></div>


<p>h. View the explain plan output to see that QPM detects a new plan but still uses the approved plan and maintains the plan stability.</p>
<div class="codehilite"><pre><span></span>mylab=&gt; explain (hashes true) 
SELECT Sum(delta),
            Sum(bbalance)
FROM   pgbench_history h,
           pgbench_branches b
WHERE  b.bid = h.bid
       AND b.bid IN ( 1, 2, 3 )
       AND mtime BETWEEN (SELECT Min(mtime)
                          FROM   pgbench_history mn) AND (SELECT Max(mtime)
                                                          FROM  pgbench_history mx); 

                      QUERY PLAN                                                  
Aggregate  (cost=23228.13..23228.14 rows=1 width=16)
   InitPlan 1 (returns $1)
     -&gt;  Finalize Aggregate  (cost=6966.00..6966.01 rows=1 width=8)
           -&gt;  Gather  (cost=6965.89..6966.00 rows=1 width=8)
                 Workers Planned: 1
                 -&gt;  Partial Aggregate  (cost=5965.89..5965.90 rows=1 width=8)
                       -&gt;  Parallel Seq Scan on pgbench_history mn  (cost=0.00..5346.11 rows=247911 width=8)
   InitPlan 2 (returns $3)
     -&gt;  Finalize Aggregate  (cost=6966.00..6966.01 rows=1 width=8)
           -&gt;  Gather  (cost=6965.89..6966.00 rows=1 width=8)
                 Workers Planned: 1
                 -&gt;  Partial Aggregate  (cost=5965.89..5965.90 rows=1 width=8)
                       -&gt;  Parallel Seq Scan on pgbench_history mx  (cost=0.00..5346.11 rows=247911 width=8)
   -&gt;  Nested Loop  (cost=0.00..9292.95 rows=632 width=8)
         Join Filter: (h.bid = b.bid)
         -&gt;  Seq Scan on pgbench_history h  (cost=0.00..9188.74 rows=2107 width=8)
               Filter: ((mtime &gt;= $1) AND (mtime &lt;= $3))
         -&gt;  Materialize  (cost=0.00..14.15 rows=3 width=8)
               -&gt;  Seq Scan on pgbench_branches b  (cost=0.00..14.14 rows=3 width=8)
                     Filter: (bid = ANY (&#39;{1,2,3}&#39;::integer[]))

………………………………………………………………………..
***Note: For this example, an approved plan was used instead of the minimum cost plan.
 SQL Hash: 1561242727, Plan Hash: -1990695905, Minimum Cost Plan Hash: -794604077***
</pre></div>


<p>i. Run the following SQL query to view the new plan and status of the plan. To ensure plan stability, QPM stores all the newly generated plans for a managed query in QPM as unapproved plans. </p>
<p>The following output shows that there are two different execution plans stored for the same managed statement, as shown by the two different plan_hash values. Although the new execution plan has the minimum cost (lower than the approved plan), QPM continues to ignore the unapproved plans to maintain plan stability.   </p>
<p>The plan_outline column in the table apg_plan_mgmt.dba_plans shows the entire plan for the SQL. For the sake of brevity, the plan_outline is not shown here. Instead, plan_hash_value from the explain plan preceding is compared with plan_hash from the output of the apg_plan_mgmt.dba_plans query.</p>
<div class="codehilite"><pre><span></span>mylab=&gt; SELECT sql_hash,
             plan_hash,
            status,
            estimated_total_cost &quot;cost&quot;,
            sql_text
FROM apg_plan_mgmt.dba_plans;
  sql_hash          |  plan_hash        |  status   | cost  |  sql_text                                                                                                         

------------+-------------+----------+---------+----------------------------









1561242727  -1990695905  Approved    23228.14        select sum(delta),sum(bbalance) from pgbench_history h, pgbench_branches b where b.bid=h.bid and b.bid in (1,2,3) and mtime between (select min(mtime) from pgbench_history mn) and (select max(mtime) from pgbench_history mx); 








1561242727  -794604077   UnApproved      111.17          select sum(delta),sum(bbalance) from pgbench_history h, pgbench_branches b where b.bid=h.bid and b.bid in (1,2,3) and mtime between (select min(mtime) from pgbench_history mn) and (select max(mtime) from pgbench_history mx); 
</pre></div>


<p>The following is an example of plan adaptability with QPM. This example evaluates the unapproved plan based on the minimum speedup factor. It approves any captured unapproved plan that is faster by at least 10 percent than the best approved plan for the statement. For additional details, <a href="https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/AuroraPostgreSQL.Optimize.Maintenance.html#AuroraPostgreSQL.Optimize.Maintenance.EvaluatingPerformance" target="_blank"> see Evaluating Plan Performance in the Aurora documentation</a>.</p>
<div class="codehilite"><pre><span></span>mylab=&gt; SELECT apg_plan_mgmt.Evolve_plan_baselines (sql_hash, plan_hash, 1.1,&#39;approve&#39;)
FROM   apg_plan_mgmt.dba_plans
WHERE  status = &#39;Unapproved&#39;; 

NOTICE: [Unapproved] SQL Hash: 1561242727, Plan Hash: 1944377599, SELECT sum(delta),sum(bbalance) from pgbench_history h, pgbench_branches b where ...
NOTICE:      Baseline   [Planning time 0.693 ms, Execution time 316.644 ms]
NOTICE:      Baseline+1 [Planning time 0.695 ms, Execution time 213.919 ms]
NOTICE:      Total time benefit: 102.723 ms, Execution time benefit: 102.725 ms, Avg Log Cardinality Error: 3.53418, Cost = 111.16..111.17
NOTICE:      Unapproved -&gt; Approved 
</pre></div>


<p>After QPM evaluates the plan based on the speed factor, the plan status changes to approved. At this point, the optimizer can choose that plan for that managed statement now.</p>
<div class="codehilite"><pre><span></span>mylab=&gt; SELECT sql_hash,
             plan_hash,
            status,
            estimated_total_cost &quot;cost&quot;,
            sql_text
FROM apg_plan_mgmt.dba_plans;
  sql_hash          |  plan_hash        |  status   | cost  |  sql_text                                                                                                         

------------+-------------+----------+---------+-----------------------------------------------------------









1561242727  -1990695905  Approved    23228.14        select sum(delta),sum(bbalance) from pgbench_history h, pgbench_branches b where b.bid=h.bid and b.bid in (1,2,3) and mtime between (select min(mtime) from pgbench_history mn) and (select max(mtime) from pgbench_history mx); 








1561242727  -794604077   Approved    111.17          select sum(delta),sum(bbalance) from pgbench_history h, pgbench_branches b where b.bid=h.bid and b.bid in (1,2,3) and mtime between (select min(mtime) from pgbench_history mn) and (select max(mtime) from pgbench_history mx); 
</pre></div>


<p>j. View the explain plan output to see whether the query is using the newly approved minimum cost plan.</p>
<div class="codehilite"><pre><span></span>mylab=&gt; explain (hashes true) 
SELECT Sum(delta),
            Sum(bbalance)
FROM   pgbench_history h,
           pgbench_branches b
WHERE  b.bid = h.bid
       AND b.bid IN ( 1, 2, 3 )
       AND mtime BETWEEN (SELECT Min(mtime)
                          FROM   pgbench_history mn) AND (SELECT Max(mtime)
                                                          FROM  pgbench_history mx); 

                                               QUERY PLAN                                                
-----------------------------------------------------------------------------
 Aggregate  (cost=111.16..111.17 rows=1 width=16)
   InitPlan 2 (returns $1)
     -&gt;  Result  (cost=0.46..0.47 rows=1 width=8)
           InitPlan 1 (returns $0)
             -&gt;  Limit  (cost=0.42..0.46 rows=1 width=8)
                   -&gt;  Index Only Scan using pgbench_hist_mtime on pgbench_history mn  (cost=0.42..14882.41 rows=421449 width=8)
                         Index Cond: (mtime IS NOT NULL)
   InitPlan 4 (returns $3)
     -&gt;  Result  (cost=0.46..0.47 rows=1 width=8)
           InitPlan 3 (returns $2)
             -&gt;  Limit  (cost=0.42..0.46 rows=1 width=8)
                   -&gt;  Index Only Scan Backward using pgbench_hist_mtime on pgbench_history mx  (cost=0.42..14882.41 rows=421449 width=8)
                         Index Cond: (mtime IS NOT NULL)
   -&gt;  Hash Join  (cost=14.60..107.06 rows=632 width=8)
         Hash Cond: (h.bid = b.bid)
         -&gt;  Index Scan using pgbench_hist_mtime on pgbench_history h  (cost=0.42..85.01 rows=2107 width=8)
               Index Cond: ((mtime &gt;= $1) AND (mtime &lt;= $3))
         -&gt;  Hash  (cost=14.14..14.14 rows=3 width=8)
               -&gt;  Seq Scan on pgbench_branches b  (cost=0.00..14.14 rows=3 width=8)
                     Filter: (bid = ANY (&#39;{1,2,3}&#39;::integer[]))


 SQL Hash: 1561242727, Plan Hash: -794604077
</pre></div>


<h2 id="5-fixing-plans-with-qpm-using-pg_hint_plan">5. Fixing plans with QPM using pg_hint_plan<a class="headerlink" href="#5-fixing-plans-with-qpm-using-pg_hint_plan" title="Permanent link">&para;</a></h2>
<p>In some cases, the query optimizer doesn’t generate the best execution plan for the query. One approach to fixing this problem is to put query hints into your application code, but this approach is widely discouraged because it makes applications more brittle and harder to maintain, and in some cases, you can’t hint the SQL because it is generated by a 3rd party application. What we will show is how to use hints to control the query optimizer, but then to remove the hints and allow QPM to enforce the desired plan, without adding hints to the application code.</p>
<p>For this purpose, PostgreSQL users can use the pg_hint_plan extension to provide directives such as “scan method,” “join method,” “join order,”, or “row number correction,” to the optimizer.  The resulting plan will be saved by QPM, along with any GUC parameters you choose to override (such as work_mem).  QPM remembers any GUC parameter overrides and uses them when it needs to recreate the plan. To install and learn more about how to use the pg_hint_plan extension, see the pg_hint_plan documentation. </p>
<p><strong><em>QPM steps to fix the plan generated by using hints</em></strong></p>
<p>Working with pg_hint_plan is incredibly useful for cases where the query can’t be modified to add hints. In this example, use a sample query to generate the execution plan that you want by adding hints to the managed statement. Then associate this execution plan with the original unmodified statement. </p>
<p><strong>Here are the detailed steps:</strong></p>
<p>a. Check if the plan capture is disabled</p>
<div class="codehilite"><pre><span></span>mylab=&gt; show apg_plan_mgmt.capture_plan_baselines;
 apg_plan_mgmt.capture_plan_baselines 
--------------------------------------
 off
(1 row)
</pre></div>


<p>b. Run the query with the hint to use. In the following example, use the “HashJoin” hint, which is a directive for the optimizer to choose the join method as HashJoin. </p>
<p>The original plan of the query without hints is as follows.</p>
<div class="codehilite"><pre><span></span>mylab=&gt; EXPLAIN (hashes true)
SELECT
   * 
FROM
   pgbench_branches b 
   JOIN
      pgbench_accounts a 
      ON b.bid = a.bid 
ORDER BY
   a.aid;                                                   

                                QUERY PLAN                                                    
----------------------------------------------------------------------
 Nested Loop  (cost=0.42..181906.82 rows=1000000 width=465)
   Join Filter: (b.bid = a.bid)
   -&gt;  Index Scan using pgbench_accounts_pkey on pgbench_accounts a  (cost=0.42..44165.43 rows=1000000 width=97)
   -&gt;  Materialize  (cost=0.00..14.15 rows=10 width=364)
         -&gt;  Seq Scan on pgbench_branches b  (cost=0.00..14.10 rows=10 width=364)
 SQL Hash: 356104612, Plan Hash: -451962956
</pre></div>


<p>c. Enable pg_hint_plan and manual plan capture: </p>
<div class="codehilite"><pre><span></span>Mylab=&gt; SET pg_hint_plan.enable_hint = true;
SET
mylab=&gt; SET apg_plan_mgmt.capture_plan_baselines = manual;
SET
</pre></div>


<p>d. EXPLAIN the query with the hints you want to use. In the following example, use the HashJoin (a, b) hint, which is a directive for the optimizer to use a hash join algorithm to join from table a to table b: </p>
<p>The plan that you want with a hash join is as follows. </p>
<div class="codehilite"><pre><span></span>mylab=&gt; /*+ HashJoin(a b) */  EXPLAIN (hashes true)
SELECT
   * 
FROM
   pgbench_branches b 
   JOIN
      pgbench_accounts a 
      ON b.bid = a.bid 
ORDER BY
   a.aid;

                            QUERY PLAN                                               
----------------------------------------------------------------------
 Gather Merge  (cost=240409.02..250138.04 rows=833334 width=465)
   Workers Planned: 2
   -&gt;  Sort  (cost=239409.00..240450.67 rows=416667 width=465)
         Sort Key: a.aid
         -&gt;  Hash Join  (cost=14.22..23920.19 rows=416667 width=465)
               Hash Cond: (a.bid = b.bid)
               -&gt;  Parallel Seq Scan on pgbench_accounts a  (cost=0.00..22348.67 rows=416667 width=97)
               -&gt;  Hash  (cost=14.10..14.10 rows=10 width=364)
                     -&gt;  Seq Scan on pgbench_branches b  (cost=0.00..14.10 rows=10 width=364)
 SQL Hash: 356104612, Plan Hash: 1139293728
</pre></div>


<p>e. Verify that plan 1139293728 was captured, and note the status of the plan
View the captured plan and the status of the plan.</p>
<div class="codehilite"><pre><span></span>mylab=&gt; 
SELECT sql_hash,
       plan_hash,
       status,
       enabled,
       sql_text
FROM   apg_plan_mgmt.dba_plans;
 Where plan_hash=1139293728;

  sql_hash  | plan_hash  |  status  | enabled |         sql_text          
-----------+------------+----------+---------+---------------------------
 356104612 | 1139293728 | Approved | t       | SELECT                   +
           |            |          |         |    *                     +
           |            |          |         | FROM                     +
           |            |          |         |    pgbench_branches b    +
           |            |          |         |    JOIN                  +
           |            |          |         |       pgbench_accounts a +
           |            |          |         |       ON b.bid = a.bid   +
           |            |          |         | ORDER BY                 +
           |            |          |         |    a.aid;
</pre></div>


<p>f. If necessary, Approve the plan
In this case this is the first and only plan saved for statement 356104612, so it was saved as an Approved plan.  If this statement already had a baseline of approved plans, then this plan would have been saved as an Unapproved plan.
In general, to Reject all existing plans for a statement and then Approve one specific plan, you could call apg_plan_mgmt.set_plan_status twice, like this:</p>
<div class="codehilite"><pre><span></span>mylab=&gt; SELECT apg_plan_mgmt.set_plan_status (sql_hash, plan_hash, &#39;Rejected&#39;) from apg_plan_mgmt.dba_plans where sql_hash = 356104612;
SET
mylab=&gt; SELECT apg_plan_mgmt.set_plan_status (356104612, 1139293728, &#39;Approved&#39;);
SET
</pre></div>


<p>g. Remove the hint, turn off manual capture, turn on use_plan_baselines, and also verify that the desired plan is in use without the hint.</p>
<div class="codehilite"><pre><span></span>mylab=&gt; SET apg_plan_mgmt.capture_plan_baselines = off;
SET
mylab=&gt; SET apg_plan_mgmt.use_plan_baselines = true;
SET
mylab=&gt; EXPLAIN (hashes true)
SELECT
   * 
FROM
   pgbench_branches b 
   JOIN
      pgbench_accounts a 
      ON b.bid = a.bid 
ORDER BY
   a.aid;             
                             QUERY PLAN                                               
----------------------------------------------------------------------
 Gather Merge  (cost=240409.02..337638.11 rows=833334 width=465)
   Workers Planned: 2
   -&gt;  Sort  (cost=239409.00..240450.67 rows=416667 width=465)
         Sort Key: a.aid
         -&gt;  Hash Join  (cost=14.22..23920.19 rows=416667 width=465)
               Hash Cond: (a.bid = b.bid)
               -&gt;  Parallel Seq Scan on pgbench_accounts a  (cost=0.00..22348.67 rows=416667 width=97)
               -&gt;  Hash  (cost=14.10..14.10 rows=10 width=364)
                     -&gt;  Seq Scan on pgbench_branches b  (cost=0.00..14.10 rows=10 width=364)
 Note: An Approved plan was used instead of the minimum cost plan.
 SQL Hash: 356104612, Plan Hash: 1139293728, Minimum Cost Plan Hash: -451962956
</pre></div>


<h2 id="6-deploying-qpm-managed-plans-globally-using-export-and-import-no-lab">6. Deploying QPM-managed plans globally using export and import <strong>(no lab)</strong><a class="headerlink" href="#6-deploying-qpm-managed-plans-globally-using-export-and-import-no-lab" title="Permanent link">&para;</a></h2>
<p>Large enterprise customers often have applications and databases deployed globally. They also often maintain several environments (Dev, QA, Staging, UAT, Preprod, and Prod) for each application database. However, managing the execution plans manually in each of the databases in specific AWS Regions and each of the database environments can be cumbersome and time-consuming.</p>
<p>QPM provides an option to export and import QPM-managed plans from one database to another database. With this option, you can manage the query execution centrally and deploy databases globally. This feature is useful for the scenarios where you investigate a set of plans on a preprod database, verify that they perform well, and then load them into a production database. </p>
<p>Here are the steps to migrate QPM-managed plans from one database to another. For additional details, <a href="https://docs.aws.amazon.com/AmazonRDS/latest/AuroraUserGuide/AuroraPostgreSQL.Optimize.Maintenance.html#AuroraPostgreSQL.Optimize.Maintenance.ExportingImporting" target="_blank"> see Exporting and Importing Plans</a>in the Aurora documentation.</p>
<ol>
<li>Export the QPM-managed plan from the source system.
To do this, from the source database with the preferred execution plan, an authorized DB user can copy any subset of the apg_plan_mgmt.plans table to another table. That user can then save it using the pg_dump command. For additional details on the pg_dump, see pg_dump in the PostgreSQL documentation.  </li>
<li>Import the QPM-managed plan on the target system.</li>
<li>On the target system, copy any subset of the apg_plan_mgmt.plans table to another table, and then save it using the pg_dump command. This is an optional step to preserve any existing managed plans on the target system before importing new plans for the source system.</li>
<li>We have assumed that you have used pg_dump tar-format archive in step 1.  Use the pg_restore command to copy the .tar file into a new table (plan_copy). For additional details about the pg_restore, see pg_restore in the PostgreSQL documentation.  </li>
<li>Merge the new table with the apg_plan_mgmt.plans table.</li>
<li>Reload the managed plans into shared memory and remove the temporary plans table.</li>
</ol>
<div class="codehilite"><pre><span></span>SELECT apg_plan_mgmt.reload(); -- Refresh shared memory with new plans.

DROP TABLE plans_copy; -- Drop the temporary plan table.
</pre></div>


<h2 id="7-disabling-qpm-and-deleting-plans-manually">7. Disabling QPM and deleting plans manually<a class="headerlink" href="#7-disabling-qpm-and-deleting-plans-manually" title="Permanent link">&para;</a></h2>
<ol>
<li>Disable the QPM 
Open your cluster-level parameter group and set the rds.enable_plan_management parameter to 0</li>
<li>Delete all the plans captured</li>
</ol>
<div class="codehilite"><pre><span></span>SELECT SUM(apg_plan_mgmt.delete_plan(sql_hash, plan_hash))
FROM apg_plan_mgmt.dba_plans;
</pre></div>


<p>3.Helpful SQL statements </p>
<div class="codehilite"><pre><span></span>SELECT sql_hash,plan_hash,status,enabled,sql_text FROM   apg_plan_mgmt.dba_plans;

SELECT sql_hash,plan_hash,status,estimated_total_cost &quot;cost&quot;,sql_text FROM apg_plan_mgmt.dba_plans; 
</pre></div>
                
                  
                
              
              
                


              
            </article>
          </div>
        </div>
      </main>
      
        
<footer class="md-footer">
  
    <div class="md-footer-nav">
      <nav class="md-footer-nav__inner md-grid">
        
          <a href="../fastclone/" title="Fast Cloning" class="md-flex md-footer-nav__link md-footer-nav__link--prev" rel="prev">
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-back md-footer-nav__button"></i>
            </div>
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Previous
                </span>
                Fast Cloning
              </span>
            </div>
          </a>
        
        
          <a href="../ccm/" title="Cluster Cache Management" class="md-flex md-footer-nav__link md-footer-nav__link--next" rel="next">
            <div class="md-flex__cell md-flex__cell--stretch md-footer-nav__title">
              <span class="md-flex__ellipsis">
                <span class="md-footer-nav__direction">
                  Next
                </span>
                Cluster Cache Management
              </span>
            </div>
            <div class="md-flex__cell md-flex__cell--shrink">
              <i class="md-icon md-icon--arrow-forward md-footer-nav__button"></i>
            </div>
          </a>
        
      </nav>
    </div>
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-footer-copyright">
        
          <div class="md-footer-copyright__highlight">
            &copy; 2019, Amazon Web Services, Inc. or its affiliates. All rights reserved.
          </div>
        
        powered by
        <a href="https://www.mkdocs.org">MkDocs</a>
        and
        <a href="https://squidfunk.github.io/mkdocs-material/">
          Material for MkDocs</a>
      </div>
      
  <div class="md-footer-social">
    <link rel="stylesheet" href="../../assets/fonts/font-awesome.css">
    
      <a href="https://mylabs.data-builder.com/" class="md-footer-social__link fa fa-home"></a>
    
      <a href="https://aws.amazon.com/rds/aurora/postgresql-features/" class="md-footer-social__link fa fa-amazon"></a>
    
      <a href="https://mylabs.data-builder.com/" class="md-footer-social__link fa fa-github"></a>
    
  </div>

    </div>
  </div>
</footer>
      
    </div>
    
      <script src="../../assets/javascripts/application.8e03edeb.js"></script>
      
      <script>app.initialize({version:"1.0.4",url:{base:"../.."}})</script>
      
    
  </body>
</html>